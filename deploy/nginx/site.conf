# HTTP → HTTPS Redirect
server {
    listen 80;
    listen [::]:80;
    server_name ki-ana.at www.ki-ana.at;

    location /.well-known/acme-challenge/ {
        root /var/www/certbot;
    }

    location / {
        return 301 https://;
    }
}

# HTTPS vhost
server {
    listen 443 ssl;
    listen [::]:443 ssl;
    server_name ki-ana.at www.ki-ana.at;

    ssl_certificate /etc/letsencrypt/live/ki-ana.at/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/ki-ana.at/privkey.pem;
    include /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;

    # ACME
    location /.well-known/acme-challenge/ {
        root /var/www/certbot;
    }

    # Health check → Backend
    location /health {
        proxy_pass http://127.0.0.1:8000/health;
        proxy_set_header Host ;
    }

    # API → Backend
    location /api/ {
        proxy_pass http://127.0.0.1:8000;
        proxy_http_version 1.1;
        proxy_set_header Host ;
        proxy_set_header X-Real-IP ;
        proxy_set_header X-Forwarded-For ;
        proxy_set_header X-Forwarded-Proto ;
    }

    # SSE Events → Backend (kein Buffering)
    location /events {
        proxy_pass http://127.0.0.1:8000;
        proxy_http_version 1.1;
        proxy_set_header Host ;
        proxy_set_header Connection ;
        proxy_set_header X-Real-IP ;
        proxy_set_header X-Forwarded-For ;
        proxy_set_header X-Forwarded-Proto ;
        proxy_buffering off;
        proxy_read_timeout 3600s;
    }

    # Static files
    location /static/ {
        root /home/kiana/ki_ana/netapi;
        index index.html;
        autoindex off;
    }

    # Root → Landingpage
    location / {
        root /home/kiana/ki_ana/netapi/static;
        index index.html;
        try_files /index.html =404;
    }

    # Short URLs → Redirects
    location = /skills   { return 301 https://ki-ana.at/static/skills.html; }
    location = /pricing  { return 301 https://ki-ana.at/static/pricing.html; }
    location = /chat     { return 301 https://ki-ana.at/static/chat.html; }
    location = /papa     { return 301 https://ki-ana.at/static/papa.html; }
}
