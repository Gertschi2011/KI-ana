<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <title>üë• Benutzerverwaltung - KI_ana</title>
  <link href="/static/styles.css?v=20251028-1200" rel="stylesheet">
  <link href="/static/chat.css?v=20251027-1520" rel="stylesheet">
  <script src="/static/nav.js?v=20251029"></script>
  <script src="/static/auto_logout.js"></script>
  <script src="/static/inactivity_logout.js"></script>
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
    }

    .main-wrapper {
      padding-top: 80px;
    }

    .container {
      max-width: 1400px;
      margin: 20px auto;
      padding: 0 20px;
    }

    .page-header {
      background: white;
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 24px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 16px;
    }

    .page-title {
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 1.8em;
      font-weight: 600;
    }

    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      box-shadow: 0 2px 8px rgba(102,126,234,0.3);
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102,126,234,0.4);
    }

    .btn-ghost {
      background: #f3f4f6;
      color: #374151;
    }

    .btn-ghost:hover {
      background: #e5e7eb;
    }

    .btn-danger {
      background: #ef4444;
      color: white;
    }

    .btn-sm {
      padding: 6px 12px;
      font-size: 0.85em;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }

    .stat-card {
      background: white;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }

    .stat-label {
      font-size: 0.85em;
      color: #6b7280;
      margin-bottom: 8px;
    }

    .stat-value {
      font-size: 2em;
      font-weight: 600;
      color: #667eea;
    }

    .users-table {
      background: white;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      overflow-x: auto;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    th {
      text-align: left;
      padding: 12px;
      border-bottom: 2px solid #e5e7eb;
      font-weight: 600;
      color: #374151;
    }

    td {
      padding: 12px;
      border-bottom: 1px solid #f3f4f6;
    }

    tr:hover {
      background: #f9fafb;
    }

    .badge {
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 0.75em;
      font-weight: 500;
      margin-right: 4px;
    }

    .badge-creator {
      background: #fee2e2;
      color: #991b1b;
    }

    .badge-admin {
      background: #fef3c7;
      color: #92400e;
    }

    .badge-user {
      background: #f3f4f6;
      color: #374151;
    }

    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 2000;
    }

    .modal-backdrop.active {
      display: flex;
    }

    .modal {
      background: white;
      border-radius: 12px;
      padding: 24px;
      width: min(500px, 90vw);
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .modal-title {
      font-size: 1.5em;
      font-weight: 600;
    }

    .form-group {
      margin-bottom: 16px;
    }

    .form-label {
      display: block;
      font-weight: 500;
      margin-bottom: 6px;
      color: #374151;
    }

    .form-input, .form-select {
      width: 100%;
      padding: 10px 14px;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      font-size: 0.95em;
    }

    .form-input:focus, .form-select:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102,126,234,0.1);
    }

    .form-actions {
      display: flex;
      gap: 12px;
      justify-content: flex-end;
      margin-top: 24px;
    }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #6b7280;
    }

    .loading {
      text-align: center;
      padding: 60px 20px;
      color: #6b7280;
      font-size: 1.2em;
    }
    
  </style>
</head>
<body>
  <div id="navbar"></div>
  <div class="container" style="padding-top: 100px;">
    <div class="page-header">
      <div class="page-title">
        <span>üë•</span>
        <span>Benutzerverwaltung</span>
      </div>
      <button class="btn btn-primary" onclick="openCreateModal()" id="createBtn">
        <span>‚ûï</span>
        <span>Neuer Benutzer</span>
      </button>
    </div>

    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-label">Gesamt Benutzer</div>
        <div class="stat-value" id="statTotal">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Creators</div>
        <div class="stat-value" id="statCreators">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Admins</div>
        <div class="stat-value" id="statAdmins">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Normal Users</div>
        <div class="stat-value" id="statUsers">0</div>
      </div>
    </div>

    <div class="users-table">
      <div id="usersContainer">
        <div class="loading">Laden...</div>
      </div>
    </div>
  </div>
  </div>

  <!-- Create/Edit Modal -->
  <div class="modal-backdrop" id="userModal">
    <div class="modal">
      <div class="modal-header">
        <h2 class="modal-title" id="modalTitle">Neuer Benutzer</h2>
        <button class="btn btn-ghost" onclick="closeModal()">√ó</button>
      </div>
      <form id="userForm">
        <div class="form-group">
          <label class="form-label">Benutzername *</label>
          <input type="text" class="form-input" id="inputUsername" required>
        </div>
        <div class="form-group">
          <label class="form-label">E-Mail *</label>
          <input type="email" class="form-input" id="inputEmail" required>
        </div>
        <div class="form-group" id="passwordGroup">
          <label class="form-label">Passwort * (min. 8 Zeichen)</label>
          <input type="password" class="form-input" id="inputPassword" minlength="8">
        </div>
        <div class="form-group">
          <label class="form-label">Rolle</label>
          <select class="form-select" id="inputRole">
            <option value="user">User</option>
            <option value="admin">Admin</option>
            <option value="creator">Creator (voller Zugriff)</option>
          </select>
        </div>
        <div class="form-actions">
          <button type="button" class="btn btn-ghost" onclick="closeModal()">Abbrechen</button>
          <button type="submit" class="btn btn-primary">Speichern</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    let users = [];
    let editingUserId = null;
    let currentUser = null;

    // Check auth and load users
    async function checkAuth() {
      try {
        // Try with session cookie first, then token
        const token = sessionStorage.getItem('ki_token') || localStorage.getItem('ki_token') || '';
        const headers = {};
        if (token) headers['Authorization'] = 'Bearer ' + token;
        
        const r = await fetch('/api/me', {
          credentials: 'include',
          headers
        });
        
        if (!r.ok) {
          console.error('Auth failed:', r.status);
          window.location.href = '/static/login.html';
          return false;
        }

        const data = await r.json();
        console.log('Auth successful:', data);
        currentUser = data.user;
        
        // Only creators can access this page
        const roles = currentUser.roles || [currentUser.role];
        console.log('User roles:', roles);
        
        if (!roles.includes('creator')) {
          alert('Zugriff verweigert. Nur Creators haben Zugriff auf diese Seite.');
          window.location.href = '/static/dashboard.html';
          return false;
        }

        return true;
      } catch (e) {
        console.error('Auth check failed:', e);
        window.location.href = '/static/login.html';
        return false;
      }
    }

    async function loadUsers() {
      try {
        const token = sessionStorage.getItem('ki_token') || localStorage.getItem('ki_token') || '';
        const headers = token ? { 'Authorization': 'Bearer ' + token } : {};
        
        const r = await fetch('/api/admin/users', {
          credentials: 'include',
          headers
        });
        
        if (!r.ok) {
          if (r.status === 401) {
            window.location.href = '/static/login.html';
            return;
          }
          throw new Error('Fehler beim Laden');
        }
        
        const data = await r.json();
        users = data.items || [];
        
        updateStats();
        renderUsers();
      } catch (e) {
        console.error('Load error:', e);
        document.getElementById('usersContainer').innerHTML = 
          '<div class="empty-state"><div style="font-size:3em">‚ö†Ô∏è</div><div>Fehler beim Laden der Benutzer</div><div style="font-size:0.9em;margin-top:8px">' + e.message + '</div></div>';
      }
    }

    function updateStats() {
      const creators = users.filter(u => {
        const roles = u.roles || [u.role];
        return roles.includes('creator');
      }).length;
      
      const admins = users.filter(u => {
        const roles = u.roles || [u.role];
        return roles.includes('admin') && !roles.includes('creator');
      }).length;
      
      const normalUsers = users.filter(u => {
        const roles = u.roles || [u.role];
        return !roles.includes('admin') && !roles.includes('creator');
      }).length;

      document.getElementById('statTotal').textContent = users.length;
      document.getElementById('statCreators').textContent = creators;
      document.getElementById('statAdmins').textContent = admins;
      document.getElementById('statUsers').textContent = normalUsers;
    }

    function renderUsers() {
      const container = document.getElementById('usersContainer');
      
      if (users.length === 0) {
        container.innerHTML = '<div class="empty-state"><div style="font-size:3em">üòî</div><div>Keine Benutzer gefunden</div></div>';
        return;
      }

      const table = `
        <table>
          <thead>
            <tr>
              <th>ID</th>
              <th>Benutzername</th>
              <th>E-Mail</th>
              <th>Rolle</th>
              <th>Erstellt</th>
              <th>Aktionen</th>
            </tr>
          </thead>
          <tbody>
            ${users.map(u => renderUserRow(u)).join('')}
          </tbody>
        </table>
      `;
      
      container.innerHTML = table;
    }

    function renderUserRow(user) {
      const roles = user.roles || [user.role];
      const isCreator = roles.includes('creator');
      const isAdmin = roles.includes('admin');
      
      let roleBadge = '';
      if (isCreator) roleBadge = '<span class="badge badge-creator">Creator</span>';
      else if (isAdmin) roleBadge = '<span class="badge badge-admin">Admin</span>';
      else roleBadge = '<span class="badge badge-user">User</span>';
      
      const created = user.created_at ? new Date(user.created_at * 1000).toLocaleDateString('de-DE') : '-';
      
      // Can't delete yourself
      const canDelete = user.id !== currentUser?.id;
      
      return `
        <tr>
          <td>${user.id}</td>
          <td><strong>${user.username || '-'}</strong></td>
          <td>${user.email || '-'}</td>
          <td>${roleBadge}</td>
          <td>${created}</td>
          <td>
            <button class="btn btn-ghost btn-sm" onclick="editUser(${user.id})">‚úèÔ∏è Bearbeiten</button>
            ${canDelete ? `<button class="btn btn-danger btn-sm" onclick="deleteUser(${user.id}, '${user.username}')">üóëÔ∏è L√∂schen</button>` : ''}
          </td>
        </tr>
      `;
    }

    function openCreateModal() {
      editingUserId = null;
      document.getElementById('modalTitle').textContent = 'Neuer Benutzer';
      document.getElementById('userForm').reset();
      document.getElementById('passwordGroup').style.display = 'block';
      document.getElementById('inputPassword').required = true;
      document.getElementById('userModal').classList.add('active');
    }

    function editUser(userId) {
      const user = users.find(u => u.id === userId);
      if (!user) return;

      editingUserId = userId;
      document.getElementById('modalTitle').textContent = 'Benutzer bearbeiten (Passwort NICHT √§nderbar)';
      document.getElementById('inputUsername').value = user.username || '';
      document.getElementById('inputEmail').value = user.email || '';
      
      const roles = user.roles || [user.role];
      if (roles.includes('creator')) document.getElementById('inputRole').value = 'creator';
      else if (roles.includes('admin')) document.getElementById('inputRole').value = 'admin';
      else document.getElementById('inputRole').value = 'user';
      
      // Hide password field when editing
      document.getElementById('passwordGroup').style.display = 'none';
      document.getElementById('inputPassword').required = false;
      
      document.getElementById('userModal').classList.add('active');
    }

    function closeModal() {
      document.getElementById('userModal').classList.remove('active');
    }

    async function deleteUser(userId, username) {
      if (!confirm(`Benutzer "${username}" wirklich l√∂schen?\n\nDies kann nicht r√ºckg√§ngig gemacht werden!`)) return;

      try {
        const token = sessionStorage.getItem('ki_token') || localStorage.getItem('ki_token') || '';
        const headers = token ? { 'Authorization': 'Bearer ' + token } : {};
        
        const r = await fetch(`/api/admin/users/${userId}`, {
          method: 'DELETE',
          credentials: 'include',
          headers
        });

        if (!r.ok) throw new Error('L√∂schen fehlgeschlagen');

        alert('Benutzer erfolgreich gel√∂scht!');
        loadUsers();
      } catch (e) {
        alert('Fehler beim L√∂schen: ' + e.message);
      }
    }

    // Form submit
    document.getElementById('userForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      const data = {
        username: document.getElementById('inputUsername').value,
        email: document.getElementById('inputEmail').value,
        role: document.getElementById('inputRole').value
      };

      // Only include password for new users
      if (!editingUserId) {
        data.password = document.getElementById('inputPassword').value;
        if (data.password.length < 8) {
          alert('Passwort muss mindestens 8 Zeichen lang sein!');
          return;
        }
      }

      try {
        const token = sessionStorage.getItem('ki_token') || localStorage.getItem('ki_token') || '';
        const headers = {
          'Content-Type': 'application/json'
        };
        if (token) headers['Authorization'] = 'Bearer ' + token;
        
        const url = editingUserId ? `/api/admin/users/${editingUserId}` : '/api/admin/users';
        const method = editingUserId ? 'PATCH' : 'POST';

        const r = await fetch(url, {
          method,
          headers,
          credentials: 'include',
          body: JSON.stringify(data)
        });

        if (!r.ok) {
          const err = await r.json().catch(() => ({}));
          throw new Error(err.detail || 'Fehler beim Speichern');
        }

        alert(editingUserId ? 'Benutzer erfolgreich aktualisiert!' : 'Benutzer erfolgreich erstellt!');
        closeModal();
        loadUsers();
      } catch (e) {
        alert('Fehler: ' + e.message);
      }
    });

    // Initialize
    async function init() {
      const authed = await checkAuth();
      if (authed) {
        loadUsers();
      }
    }

    init();
  </script>

  <!-- Load Navbar -->
  <script>
  (async function(){
    try{
      const r = await fetch('/static/nav.html?v=' + Date.now());
      const html = await r.text();
      const nav = document.getElementById('navbar');
      if(nav) {
        nav.innerHTML = html;
        nav.querySelectorAll('script').forEach(old => {
          const s = document.createElement('script');
          if(old.src) { 
            s.src = old.src + (old.src.includes('?')?'&':'?') + 'v=' + Date.now(); 
          } else { 
            s.textContent = old.textContent || ''; 
          }
          document.body.appendChild(s);
          old.remove();
        });
      }
    }catch(e){
      console.error('Navbar load failed:', e);
    }
  })();
  </script>
</body>
</html>
