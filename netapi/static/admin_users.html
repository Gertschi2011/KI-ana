<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>üë• Benutzerverwaltung - KI_ana</title>
  <link href="/static/styles.css" rel="stylesheet">
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
    }

    .navbar {
      position: fixed!important;
      top: 0!important;
      left: 0!important;
      right: 0!important;
      z-index: 1000!important;
    }

    .container {
      max-width: 1400px;
      margin: 80px auto 20px;
      padding: 20px;
    }

    .header {
      background: white;
      border-radius: 16px;
      padding: 24px;
      margin-bottom: 20px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 16px;
    }

    .header-title {
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 1.8em;
      font-weight: 600;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .header-actions {
      display: flex;
      gap: 12px;
      align-items: center;
    }

    .search-box {
      position: relative;
      flex: 1;
      min-width: 300px;
      max-width: 500px;
    }

    .search-input {
      width: 100%;
      padding: 12px 16px 12px 44px;
      border: 2px solid #e5e7eb;
      border-radius: 12px;
      font-size: 0.95em;
      transition: all 0.2s;
    }

    .search-input:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 4px rgba(102,126,234,0.1);
    }

    .search-icon {
      position: absolute;
      left: 14px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 1.2em;
      opacity: 0.5;
    }

    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 12px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      box-shadow: 0 4px 12px rgba(102,126,234,0.3);
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(102,126,234,0.4);
    }

    .btn-ghost {
      background: #f3f4f6;
      color: #374151;
    }

    .btn-ghost:hover {
      background: #e5e7eb;
    }

    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 20px;
    }

    .stat-card {
      background: white;
      border-radius: 16px;
      padding: 20px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    }

    .stat-label {
      font-size: 0.85em;
      color: #6b7280;
      margin-bottom: 8px;
    }

    .stat-value {
      font-size: 2em;
      font-weight: 600;
      color: #667eea;
    }

    .users-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
      gap: 16px;
    }

    .user-card {
      background: white;
      border-radius: 16px;
      padding: 20px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      transition: all 0.2s;
      position: relative;
      overflow: hidden;
    }

    .user-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 24px rgba(0,0,0,0.12);
    }

    .user-card-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 16px;
    }

    .user-avatar {
      width: 56px;
      height: 56px;
      border-radius: 50%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 1.5em;
      font-weight: 600;
      flex-shrink: 0;
    }

    .user-info {
      flex: 1;
      min-width: 0;
    }

    .user-name {
      font-weight: 600;
      font-size: 1.1em;
      margin-bottom: 4px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .user-email {
      font-size: 0.85em;
      color: #6b7280;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .user-badges {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-bottom: 12px;
    }

    .badge {
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 0.75em;
      font-weight: 500;
    }

    .badge-admin {
      background: #fee2e2;
      color: #991b1b;
    }

    .badge-papa {
      background: #dbeafe;
      color: #1e40af;
    }

    .badge-user {
      background: #f3f4f6;
      color: #374151;
    }

    .badge-free {
      background: #d1fae5;
      color: #065f46;
    }

    .badge-pro {
      background: #fef3c7;
      color: #92400e;
    }

    .user-meta {
      display: flex;
      gap: 16px;
      font-size: 0.85em;
      color: #6b7280;
      margin-bottom: 12px;
    }

    .user-actions {
      display: flex;
      gap: 8px;
    }

    .btn-sm {
      padding: 6px 12px;
      font-size: 0.85em;
      border-radius: 8px;
    }

    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 2000;
    }

    .modal-backdrop.active {
      display: flex;
    }

    .modal {
      background: white;
      border-radius: 16px;
      padding: 24px;
      width: min(500px, 90vw);
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .modal-title {
      font-size: 1.5em;
      font-weight: 600;
    }

    .close-btn {
      background: none;
      border: none;
      font-size: 1.5em;
      cursor: pointer;
      opacity: 0.6;
      transition: opacity 0.2s;
    }

    .close-btn:hover {
      opacity: 1;
    }

    .form-group {
      margin-bottom: 16px;
    }

    .form-label {
      display: block;
      font-weight: 500;
      margin-bottom: 6px;
      color: #374151;
    }

    .form-input, .form-select {
      width: 100%;
      padding: 10px 14px;
      border: 2px solid #e5e7eb;
      border-radius: 10px;
      font-size: 0.95em;
      transition: all 0.2s;
    }

    .form-input:focus, .form-select:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102,126,234,0.1);
    }

    .form-actions {
      display: flex;
      gap: 12px;
      justify-content: flex-end;
      margin-top: 24px;
    }

    .loading {
      text-align: center;
      padding: 60px 20px;
      color: white;
      font-size: 1.2em;
    }

    .empty-state {
      text-align: center;
      padding: 80px 20px;
      background: white;
      border-radius: 16px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    }

    .empty-icon {
      font-size: 4em;
      margin-bottom: 16px;
    }

    .filter-bar {
      background: white;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 20px;
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      align-items: center;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }

    .filter-label {
      font-weight: 500;
      color: #6b7280;
    }

    .filter-btn {
      padding: 8px 16px;
      border: 2px solid #e5e7eb;
      background: white;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .filter-btn.active {
      border-color: #667eea;
      background: #ede9fe;
      color: #667eea;
    }
  </style>
</head>
<body>
  <div id="nav"></div>

  <div class="container">
    <div class="header">
      <div class="header-title">
        <span>üë•</span>
        <span>Benutzerverwaltung</span>
      </div>
      <div class="header-actions">
        <div class="search-box">
          <span class="search-icon">üîç</span>
          <input 
            type="text" 
            class="search-input" 
            placeholder="Benutzer suchen..."
            id="searchInput"
          >
        </div>
        <button class="btn btn-primary" onclick="openCreateModal()">
          <span>‚ûï</span>
          <span>Neuer Benutzer</span>
        </button>
      </div>
    </div>

    <div class="stats">
      <div class="stat-card">
        <div class="stat-label">Gesamt Benutzer</div>
        <div class="stat-value" id="statTotal">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Admins</div>
        <div class="stat-value" id="statAdmins">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Papa Users</div>
        <div class="stat-value" id="statPapas">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Aktive heute</div>
        <div class="stat-value" id="statActive">0</div>
      </div>
    </div>

    <div class="filter-bar">
      <span class="filter-label">Filter:</span>
      <button class="filter-btn active" data-filter="all">Alle</button>
      <button class="filter-btn" data-filter="admin">Admins</button>
      <button class="filter-btn" data-filter="papa">Papas</button>
      <button class="filter-btn" data-filter="user">Normale User</button>
    </div>

    <div id="usersContainer"></div>
  </div>

  <!-- Create/Edit Modal -->
  <div class="modal-backdrop" id="userModal">
    <div class="modal">
      <div class="modal-header">
        <h2 class="modal-title" id="modalTitle">Neuer Benutzer</h2>
        <button class="close-btn" onclick="closeModal()">√ó</button>
      </div>
      <form id="userForm">
        <div class="form-group">
          <label class="form-label">Benutzername *</label>
          <input type="text" class="form-input" id="inputUsername" required>
        </div>
        <div class="form-group">
          <label class="form-label">E-Mail *</label>
          <input type="email" class="form-input" id="inputEmail" required>
        </div>
        <div class="form-group" id="passwordGroup">
          <label class="form-label">Passwort *</label>
          <input type="password" class="form-input" id="inputPassword" minlength="8">
        </div>
        <div class="form-group">
          <label class="form-label">Rolle</label>
          <select class="form-select" id="inputRole">
            <option value="user">User</option>
            <option value="admin">Admin</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">
            <input type="checkbox" id="inputPapa"> Papa-Zugang
          </label>
        </div>
        <div class="form-group">
          <label class="form-label">Plan</label>
          <select class="form-select" id="inputPlan">
            <option value="free">Free</option>
            <option value="pro">Pro</option>
            <option value="unlimited">Unlimited</option>
          </select>
        </div>
        <div class="form-actions">
          <button type="button" class="btn btn-ghost" onclick="closeModal()">Abbrechen</button>
          <button type="submit" class="btn btn-primary">Speichern</button>
        </div>
      </form>
    </div>
  </div>

  <script src="/static/nav.js?v=20251029"></script>
  <script>
    let users = [];
    let currentFilter = 'all';
    let currentSearch = '';
    let editingUserId = null;

    // Load users
    async function loadUsers() {
      try {
        const r = await fetch('/api/admin/users', {
          credentials: 'include'
        });
        
        if (!r.ok) throw new Error('Fehler beim Laden');
        
        const data = await r.json();
        users = data.users || [];
        
        updateStats();
        renderUsers();
      } catch (e) {
        console.error('Load error:', e);
        document.getElementById('usersContainer').innerHTML = 
          '<div class="empty-state"><div class="empty-icon">‚ö†Ô∏è</div><div>Fehler beim Laden der Benutzer</div></div>';
      }
    }

    function updateStats() {
      const admins = users.filter(u => (u.roles || [u.role]).includes('admin')).length;
      const papas = users.filter(u => u.is_papa).length;
      const today = Math.floor(Date.now() / 1000) - 86400;
      const active = users.filter(u => (u.last_login || 0) > today).length;

      document.getElementById('statTotal').textContent = users.length;
      document.getElementById('statAdmins').textContent = admins;
      document.getElementById('statPapas').textContent = papas;
      document.getElementById('statActive').textContent = active;
    }

    function renderUsers() {
      const container = document.getElementById('usersContainer');
      
      // Filter
      let filtered = users.filter(u => {
        // Role filter
        const roles = u.roles || [u.role];
        if (currentFilter === 'admin' && !roles.includes('admin')) return false;
        if (currentFilter === 'papa' && !u.is_papa) return false;
        if (currentFilter === 'user' && (roles.includes('admin') || u.is_papa)) return false;
        
        // Search filter
        if (currentSearch) {
          const search = currentSearch.toLowerCase();
          const username = (u.username || '').toLowerCase();
          const email = (u.email || '').toLowerCase();
          if (!username.includes(search) && !email.includes(search)) return false;
        }
        
        return true;
      });

      if (filtered.length === 0) {
        container.innerHTML = '<div class="empty-state"><div class="empty-icon">üòî</div><div>Keine Benutzer gefunden</div></div>';
        return;
      }

      container.innerHTML = '<div class="users-grid">' + filtered.map(u => renderUserCard(u)).join('') + '</div>';
    }

    function renderUserCard(user) {
      const roles = user.roles || [user.role];
      const isAdmin = roles.includes('admin');
      const isPapa = user.is_papa;
      const initial = (user.username || 'U')[0].toUpperCase();
      
      const rolesBadges = [];
      if (isAdmin) rolesBadges.push('<span class="badge badge-admin">Admin</span>');
      if (isPapa) rolesBadges.push('<span class="badge badge-papa">Papa</span>');
      if (!isAdmin && !isPapa) rolesBadges.push('<span class="badge badge-user">User</span>');
      
      const plan = user.plan || 'free';
      const planBadge = plan === 'free' 
        ? '<span class="badge badge-free">Free</span>'
        : '<span class="badge badge-pro">Pro</span>';

      return `
        <div class="user-card">
          <div class="user-card-header">
            <div class="user-avatar">${initial}</div>
            <div class="user-info">
              <div class="user-name">${user.username || 'Unbekannt'}</div>
              <div class="user-email">${user.email || '-'}</div>
            </div>
          </div>
          <div class="user-badges">
            ${rolesBadges.join('')}
            ${planBadge}
          </div>
          <div class="user-meta">
            <div>üÜî ${user.id}</div>
            <div>üìÖ ${formatDate(user.created_at)}</div>
          </div>
          <div class="user-actions">
            <button class="btn btn-ghost btn-sm" onclick="editUser(${user.id})">‚úèÔ∏è Bearbeiten</button>
            <button class="btn btn-ghost btn-sm" onclick="deleteUser(${user.id}, '${user.username}')">üóëÔ∏è L√∂schen</button>
          </div>
        </div>
      `;
    }

    function formatDate(timestamp) {
      if (!timestamp) return 'Unbekannt';
      const date = new Date(timestamp * 1000);
      return date.toLocaleDateString('de-DE');
    }

    // Modal functions
    function openCreateModal() {
      editingUserId = null;
      document.getElementById('modalTitle').textContent = 'Neuer Benutzer';
      document.getElementById('userForm').reset();
      document.getElementById('passwordGroup').style.display = 'block';
      document.getElementById('userModal').classList.add('active');
    }

    function editUser(userId) {
      const user = users.find(u => u.id === userId);
      if (!user) return;

      editingUserId = userId;
      document.getElementById('modalTitle').textContent = 'Benutzer bearbeiten';
      document.getElementById('inputUsername').value = user.username || '';
      document.getElementById('inputEmail').value = user.email || '';
      document.getElementById('inputRole').value = (user.roles || [user.role])[0] || 'user';
      document.getElementById('inputPapa').checked = user.is_papa || false;
      document.getElementById('inputPlan').value = user.plan || 'free';
      document.getElementById('passwordGroup').style.display = 'none';
      document.getElementById('userModal').classList.add('active');
    }

    function closeModal() {
      document.getElementById('userModal').classList.remove('active');
    }

    async function deleteUser(userId, username) {
      if (!confirm(`Benutzer "${username}" wirklich l√∂schen?`)) return;

      try {
        const r = await fetch(`/api/admin/users/${userId}`, {
          method: 'DELETE',
          credentials: 'include'
        });

        if (!r.ok) throw new Error('L√∂schen fehlgeschlagen');

        alert('Benutzer gel√∂scht!');
        loadUsers();
      } catch (e) {
        alert('Fehler: ' + e.message);
      }
    }

    // Form submit
    document.getElementById('userForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      const data = {
        username: document.getElementById('inputUsername').value,
        email: document.getElementById('inputEmail').value,
        role: document.getElementById('inputRole').value,
        is_papa: document.getElementById('inputPapa').checked,
        plan: document.getElementById('inputPlan').value
      };

      if (!editingUserId) {
        data.password = document.getElementById('inputPassword').value;
      }

      try {
        const url = editingUserId ? `/api/admin/users/${editingUserId}` : '/api/admin/users';
        const method = editingUserId ? 'PATCH' : 'POST';

        const r = await fetch(url, {
          method,
          headers: {'Content-Type': 'application/json'},
          credentials: 'include',
          body: JSON.stringify(data)
        });

        if (!r.ok) {
          const err = await r.json();
          throw new Error(err.detail || 'Fehler beim Speichern');
        }

        alert(editingUserId ? 'Benutzer aktualisiert!' : 'Benutzer erstellt!');
        closeModal();
        loadUsers();
      } catch (e) {
        alert('Fehler: ' + e.message);
      }
    });

    // Search
    document.getElementById('searchInput').addEventListener('input', (e) => {
      currentSearch = e.target.value;
      renderUsers();
    });

    // Filter buttons
    document.querySelectorAll('.filter-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        currentFilter = btn.dataset.filter;
        renderUsers();
      });
    });

    // Load on start
    loadUsers();
  </script>
</body>
</html>
