<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>KI_ana – LiveLog</title>
  <link rel="stylesheet" href="/static/chat.css" />
  <style>
    .ll-wrap{max-width:1100px;margin:24px auto;padding:0 16px}
    .ll-head{display:flex;align-items:flex-end;justify-content:space-between;gap:12px;flex-wrap:wrap}
    .ll-title{margin:0;font-size:22px}
    .ll-sub{margin:6px 0 0 0;color:#6b7280;font-size:14px}
    .ll-controls{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .ll-pill{display:inline-flex;align-items:center;gap:8px;padding:8px 10px;border:1px solid #e5e7eb;border-radius:999px;background:#fff}
    .dot{width:10px;height:10px;border-radius:999px;background:#ef4444;display:inline-block}
    .dot.ok{background:#22c55e}
    .dot.warn{background:#f59e0b}
    .ll-btn{border:0;border-radius:12px;padding:10px 12px;background:linear-gradient(135deg,#7F5AF0,#00d2ff);color:#fff;cursor:pointer}
    .ll-btn.secondary{background:#111827}
    .ll-grid{display:grid;grid-template-columns:1.6fr 1fr;gap:14px;margin-top:16px}
    @media (max-width: 980px){.ll-grid{grid-template-columns:1fr}}
    .card{background:#fff;border:1px solid #e5e7eb;border-radius:16px;box-shadow:0 10px 28px rgba(0,0,0,.06)}
    .card h3{margin:0;padding:12px 14px;border-bottom:1px solid #eef2f7;font-size:15px;color:#111827}
    .card .body{padding:12px 14px}
    table{width:100%;border-collapse:collapse;font-size:13px}
    th,td{border-bottom:1px solid #eef2f7;padding:8px 6px;text-align:left;vertical-align:top}
    th{color:#6b7280;font-weight:600}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;font-size:12px}
    .muted{color:#6b7280}
    .badge{display:inline-block;padding:2px 8px;border-radius:999px;background:#f3f4f6;color:#111827;font-size:12px}
    .err{color:#b91c1c}
    .ok{color:#166534}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    input{border:1px solid #e5e7eb;border-radius:12px;padding:10px 12px;font-size:14px}
  </style>
</head>
<body>
  <div id="nav" data-src="/static/nav.html"></div>

  <div class="ll-wrap">
    <div class="ll-head">
      <div>
        <h1 class="ll-title">LiveLog</h1>
        <p class="ll-sub">SSE-Stream aus <span class="mono">/api/livelog/stream</span> + Top-Offender aus <span class="mono">/api/livelog/stats</span>.</p>
      </div>
      <div class="ll-controls">
        <span class="ll-pill"><span id="llDot" class="dot" aria-hidden></span><span id="llState" class="mono">disconnected</span></span>
        <input id="filter" placeholder="Filter (kind/cmd/path)" style="min-width:260px" />
        <button id="clear" class="ll-btn secondary">Clear</button>
        <a class="ll-btn" href="/app/livelog" style="text-decoration:none">Pro-Ansicht</a>
      </div>
    </div>

    <div class="ll-grid">
      <div class="card">
        <h3>Last events</h3>
        <div class="body" style="padding:0">
          <table>
            <thead>
              <tr>
                <th style="width:170px">ts</th>
                <th style="width:120px">kind</th>
                <th>details</th>
              </tr>
            </thead>
            <tbody id="events"></tbody>
          </table>
        </div>
      </div>

      <div class="card">
        <h3>Top writers (snapshot)</h3>
        <div class="body">
          <div class="row">
            <div style="flex:1">
              <div class="muted" style="margin-bottom:6px">by pid</div>
              <div id="byPid"></div>
            </div>
            <div style="flex:1">
              <div class="muted" style="margin-bottom:6px">by container</div>
              <div id="byContainer"></div>
            </div>
          </div>
          <div style="margin-top:12px">
            <div class="muted" style="margin-bottom:6px">by cmd</div>
            <div id="byCmd"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="/static/nav.js"></script>
  <script>
    const MAX_ROWS = 200;
    const tbody = document.getElementById('events');
    const dot = document.getElementById('llDot');
    const state = document.getElementById('llState');
    const filterEl = document.getElementById('filter');
    const clearBtn = document.getElementById('clear');

    function setState(kind, text){
      state.textContent = text;
      dot.classList.remove('ok','warn');
      if(kind==='ok') dot.classList.add('ok');
      else if(kind==='warn') dot.classList.add('warn');
    }

    function esc(s){
      try{ return String(s).replace(/[&<>"']/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c])); }catch{ return ''; }
    }

    function matchesFilter(e){
      const q = (filterEl.value||'').trim().toLowerCase();
      if(!q) return true;
      const hay = [e.kind, e.path, e.cmd, e.msg, e.container].map(x=>String(x||'').toLowerCase()).join(' | ');
      return hay.includes(q);
    }

    function renderRow(e){
      const ts = esc(e.ts||'');
      const kind = esc(e.kind||'');
      const msg = esc(e.msg||'');
      const path = esc(e.path||'');
      const cmd = esc(e.cmd||'');
      const pid = esc(e.pid||'');
      const container = esc(e.container||'');
      const size = (e.size!=null) ? esc(e.size) : '';
      const lvl = String(e.level||'').toLowerCase();
      const cls = (lvl==='error' || lvl==='warn') ? 'err' : '';

      const details = [
        msg ? `<div class="${cls}">${msg}</div>` : '',
        path ? `<div class="mono">path: ${path}</div>` : '',
        cmd ? `<div class="mono">cmd: ${cmd}</div>` : '',
        pid ? `<div class="mono">pid: ${pid}</div>` : '',
        container ? `<div class="mono">container: ${container}</div>` : '',
        size ? `<div class="mono">size: ${size}</div>` : ''
      ].filter(Boolean).join('');

      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td class="mono muted">${ts}</td>
        <td><span class="badge">${kind}</span></td>
        <td>${details}</td>
      `;
      return tr;
    }

    function addEvent(e){
      if(!matchesFilter(e)) return;
      tbody.insertBefore(renderRow(e), tbody.firstChild);
      while(tbody.children.length > MAX_ROWS){ tbody.removeChild(tbody.lastChild); }
    }

    clearBtn.addEventListener('click', ()=>{ tbody.innerHTML=''; });

    async function loadTail(){
      try{
        const r = await fetch('/api/livelog/tail?limit=80', { credentials:'include' });
        if(!r.ok) return;
        const j = await r.json();
        const items = Array.isArray(j.items) ? j.items : [];
        tbody.innerHTML='';
        items.filter(matchesFilter).slice(-MAX_ROWS).reverse().forEach(addEvent);
      }catch{}
    }

    function renderTop(el, items){
      try{
        el.innerHTML = '';
        (items||[]).slice(0,8).forEach(it=>{
          const div = document.createElement('div');
          div.className = 'mono';
          div.textContent = `${it.key}  (${it.count})`;
          el.appendChild(div);
        });
      }catch{}
    }

    async function pollStats(){
      try{
        const r = await fetch('/api/livelog/stats?window=2000&top=15', { credentials:'include' });
        if(!r.ok) return;
        const j = await r.json();
        renderTop(document.getElementById('byPid'), j.by_pid);
        renderTop(document.getElementById('byContainer'), j.by_container);
        renderTop(document.getElementById('byCmd'), j.by_cmd);
      }catch{}
    }

    // SSE
    let es = null;
    function connect(){
      try{ if(es) es.close(); }catch{}
      setState('warn','connecting…');
      es = new EventSource('/api/livelog/stream');
      es.onopen = ()=> setState('ok','connected');
      es.onerror = ()=> setState('warn','reconnecting…');
      es.onmessage = (ev)=>{
        try{
          const e = JSON.parse(ev.data);
          addEvent(e);
        }catch{}
      };
    }

    filterEl.addEventListener('input', ()=>{ loadTail(); });

    connect();
    loadTail();
    pollStats();
    setInterval(pollStats, 4000);
  </script>
</body>
</html>
