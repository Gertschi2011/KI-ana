<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8">
  <title>Block Viewer ‚Äì KI_ana</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="icon" href="/static/favicon.ico">
  <link href="/static/styles.css" rel="stylesheet">
  <link href="/static/chat.css" rel="stylesheet">
  <style>
    body { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; }
    body.embed { background: #ffffff; min-height: 100vh; }
    body.embed .container { padding: 12px; }
    body.embed #navbar { display: none !important; }
    .container { max-width: 1200px; margin: 0 auto; padding: 24px; }
    .toolbar { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .muted { opacity: .75; }
    
    /* Table Styling */
    table { width:100%; border-collapse: collapse; background:white; border-radius:12px; overflow:hidden; box-shadow:0 2px 8px rgba(0,0,0,0.1); }
    th, td { text-align:left; padding: 12px 15px; border-bottom: 1px solid #f3f4f6; }
    th { background: linear-gradient(to bottom, #f9fafb, #f3f4f6); font-weight:600; color:#374151; font-size:13px; text-transform:uppercase; letter-spacing:0.5px; }
    tbody tr:hover { background: #fafbfc; }
    tbody tr { transition: background 0.15s ease; }
    
    /* Status Badges */
    .tag { display:inline-block; padding:4px 10px; border-radius:6px; background:#e0e7ff; color:#4338ca; font-size:11px; font-weight:600; margin-right: 4px; }
    .ok { color: #10b981; font-weight:600; }
    .bad { color: #ef4444; font-weight:600; }
    .pill { padding:6px 14px; border-radius: 8px; background: #f3f4f6; font-size: 13px; font-weight:500; border:none; cursor:pointer; transition: all 0.2s ease; }
    .pill:hover { transform: translateY(-1px); box-shadow: 0 4px 8px rgba(0,0,0,0.15); }
    .pill:active { transform: translateY(0); }
    
    .row-actions a { margin-right: 8px; color:#3b82f6; text-decoration:none; font-weight:500; }
    .row-actions a:hover { text-decoration:underline; }
    .controls { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .toolbar { flex-wrap: wrap; }
    input[type="text"] { padding:8px; border:1px solid #ddd; border-radius:8px; min-width: 240px; }
    label { display:flex; gap:6px; align-items:center; }
    /* List container can scroll horizontally if needed */
    #list { overflow-x:auto; }
    /* Table: fixed layout and sticky header */
    #blocks-table { table-layout: fixed; }
    #blocks-table th, #blocks-table td { word-break: break-word; }
    #blocks-table thead th { position: sticky; top: 0; z-index: 1; background: #f5f5f5; }
    /* Cards */
    .cards { display:grid; grid-template-columns: repeat(3, minmax(260px, 1fr)); gap:12px; margin-top:10px; }
    @media (max-width: 980px){ .cards { grid-template-columns: repeat(2, minmax(220px, 1fr)); } }
    @media (max-width: 640px){ .cards { grid-template-columns: 1fr; } }
    .card-item { background:#fff; border:1px solid #eee; border-radius:12px; padding:12px; box-shadow: 0 2px 8px rgba(16,24,40,0.06); display:flex; flex-direction:column; gap:8px; }
    .card-head { display:flex; gap:8px; align-items:center; justify-content:space-between; }
    .card-title { font-weight:700; }
    .badge { display:inline-block; padding:2px 8px; border-radius:999px; background:#eef3fb; color:#23408f; font-size:12px; border:1px solid #d7e2f3; }
    .muted-sm { color:#667085; font-size: 12px; }
    /* Modal */
    .modal { position: fixed; inset: 0; background: rgba(0,0,0,.35); display:none; align-items:center; justify-content:center; padding: 16px; }
    .modal .modal-content { background: #fff; color: #222; border-radius: 10px; max-width: 960px; width: 100%; max-height: 85vh; overflow: auto; box-shadow: 0 8px 28px rgba(0,0,0,.35); }
    .modal-header { display:flex; align-items:center; gap: 8px; padding: 10px 12px; border-bottom: 1px solid #eee; }
    .modal-header h3 { margin: 0; font-size: 18px; }
    .modal-header button { margin-left:auto; background:transparent; border:1px solid #ddd; border-radius:8px; padding: 2px 8px; cursor:pointer; }
    .modal-body { padding: 12px; }
    .modal-body .meta { display:grid; grid-template-columns: 1fr 1fr; gap: 8px 12px; align-items: baseline; }
    .modal-body pre { background: #0b1021; color: #dfe6ff; padding: 12px; border-radius: 10px; overflow:auto; }
    .rating-row { display:flex; align-items:center; gap:8px; }
    /* Responsive tweaks */
    @media (max-width: 900px){
      /* hide Bytes column (7) */
      #blocks-table th:nth-child(7), #blocks-table td:nth-child(7){ display:none; }
    }
    @media (max-width: 720px){
      /* hide Trust column (9) */
      #blocks-table th:nth-child(9), #blocks-table td:nth-child(9){ display:none; }
    }
    @media (max-width: 560px){
      /* hide Topic column (3) and make inputs full width */
      #blocks-table th:nth-child(3), #blocks-table td:nth-child(3){ display:none; }
      input[type="text"] { min-width: 100%; flex: 1 1 100%; }
      .modal-body .meta { grid-template-columns: 1fr; }
    }
    @media (max-width: 460px){
      /* hide Quelle column (4) */
      #blocks-table th:nth-child(4), #blocks-table td:nth-child(4){ display:none; }
      .pill, .controls select, .toolbar button { font-size: 12px; padding: 6px 8px; }
    }
  </style>
  <script defer src="/static/block_viewer.js"></script>
</head>
<body>
  <div id="navbar"></div>
  <main class="container">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
      <div>
        <h1 style="margin:0; font-size:28px;">üîç KI_ana Block Viewer</h1>
        <p style="margin:5px 0 0; color:#666; font-size:14px;"><span id="count">0 Bl√∂cke</span> ¬∑ <span id="healthPill" style="display:inline;"></span></p>
      </div>
      <div style="display:flex; gap:8px;">
        <button id="exportCsv" class="pill" style="background:#10b981; color:white;" title="Aktuelle Ansicht als CSV exportieren">üì• CSV Export</button>
        <button id="rehashAllBtn" class="pill" style="background:#3b82f6; color:white;" title="Alle Bl√∂cke pr√ºfen und Hashes neu berechnen">üîÑ Rehash</button>
        <button id="signAllBtn" class="pill" style="background:#8b5cf6; color:white;" title="Alle Bl√∂cke mit Ed25519 signieren">üîê Signieren</button>
      </div>
    </div>

    <!-- Search & Filter Section -->
    <div style="background:white; border-radius:12px; padding:20px; margin-bottom:20px; box-shadow:0 2px 8px rgba(0,0,0,0.1);">
      <div style="display:grid; grid-template-columns: 1fr auto; gap:15px; margin-bottom:15px;">
        <div>
          <label style="display:block; font-weight:600; margin-bottom:8px; color:#374151;">üîé Suche</label>
          <input id="q" type="text" placeholder="Suche nach Titel, Topic, Quelle oder Inhalt..." 
                 style="width:100%; padding:10px 15px; border:2px solid #e5e7eb; border-radius:8px; font-size:14px;">
        </div>
        <div style="min-width:200px;">
          <label style="display:block; font-weight:600; margin-bottom:8px; color:#374151;">üìä Ansicht</label>
          <select id="viewMode" style="width:100%; padding:10px 15px; border:2px solid #e5e7eb; border-radius:8px; font-size:14px; cursor:pointer;">
            <option value="table">üìã Tabelle</option>
            <option value="cards">üé¥ Karten</option>
          </select>
        </div>
      </div>
      
      <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap:15px;">
        <div>
          <label style="display:block; font-weight:600; margin-bottom:8px; color:#374151;">üîê Status</label>
          <label style="display:flex; align-items:center; padding:10px 15px; background:#f9fafb; border-radius:8px; cursor:pointer;">
            <input id="verifiedOnly" type="checkbox" style="width:18px; height:18px; margin-right:10px; cursor:pointer;">
            <span style="font-size:14px;">Nur verifizierte Bl√∂cke</span>
          </label>
        </div>
        
        <div>
          <label style="display:block; font-weight:600; margin-bottom:8px; color:#374151;">üìë Sortierung</label>
          <select id="sortBy" style="width:100%; padding:10px 15px; border:2px solid #e5e7eb; border-radius:8px; font-size:14px; cursor:pointer;">
            <option value="none">Standard (ID)</option>
            <option value="trust">‚≠ê Trust Score (h√∂chste zuerst)</option>
            <option value="rating">üëç Rating (beste zuerst)</option>
            <option value="time">üïí Zeit (neueste zuerst)</option>
          </select>
        </div>
        
        <div>
          <label style="display:block; font-weight:600; margin-bottom:8px; color:#374151;">üìÑ Pro Seite</label>
          <select id="pageSize" style="width:100%; padding:10px 15px; border:2px solid #e5e7eb; border-radius:8px; font-size:14px; cursor:pointer;">
            <option value="25">25 Bl√∂cke</option>
            <option value="50" selected>50 Bl√∂cke</option>
            <option value="100">100 Bl√∂cke</option>
            <option value="200">200 Bl√∂cke</option>
          </select>
        </div>
      </div>
      
      <div style="display:flex; gap:8px; margin-top:15px; flex-wrap:wrap;">
        <span id="coveragePill" class="pill" style="background:#f3f4f6; color:#374151; display:none;"></span>
        <span id="rehashAllStatus" class="muted"></span>
        <span id="signAllStatus" class="muted"></span>
      </div>
    </div>
    <div id="list">
      <p>Lade Bl√∂cke‚Ä¶</p>
    </div>
    <!-- Pagination -->
    <div style="background:white; border-radius:12px; padding:15px 20px; margin-top:20px; box-shadow:0 2px 8px rgba(0,0,0,0.1); display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:15px;">
      <div id="pagerInfo" style="font-size:14px; color:#6b7280; font-weight:500;">‚Äî</div>
      <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
        <button id="prevPage" class="pill" style="background:#f3f4f6; color:#374151; padding:8px 16px; font-weight:600;">‚óÄ Zur√ºck</button>
        <div style="display:flex; gap:8px; align-items:center;">
          <label style="font-size:14px; color:#6b7280;">Seite:</label>
          <input id="pageJump" type="number" min="1" value="1" style="width:70px; padding:8px; border:2px solid #e5e7eb; border-radius:8px; text-align:center; font-weight:600;" />
          <button id="goPage" class="pill" style="background:#3b82f6; color:white; padding:8px 12px;">‚Üí</button>
        </div>
        <button id="nextPage" class="pill" style="background:#f3f4f6; color:#374151; padding:8px 16px; font-weight:600;">Weiter ‚ñ∂</button>
      </div>
      <label style="display:flex; align-items:center; font-size:14px; color:#6b7280;">
        <input id="exportAllToggle" type="checkbox" style="margin-right:6px;" />
        Alle exportieren
      </label>
    </div>
    <!-- Detail Modal -->
    <div id="detail-modal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3 id="detail-title">Block Details</h3>
          <button id="detail-close" aria-label="close">√ó</button>
        </div>
        <div class="modal-body">
          <div class="meta">
            <div><strong>Block-ID:</strong> <span id="detail-block-id"></span></div>
            <div><strong>Topic:</strong> <span id="detail-topic"></span></div>
            <div><strong>Source:</strong> <span id="detail-source"></span></div>
            <div><strong>Path:</strong> <code id="detail-path"></code></div>
            <div><strong>Timestamp:</strong> <span id="detail-ts"></span></div>
            <div><strong>Trust:</strong> <span id="detail-trust"></span></div>
            <div>
              <a id="detail-open-json" href="#" target="_blank" rel="noopener" class="pill">JSON in neuem Tab</a>
              <a id="detail-download" href="#" target="_blank" rel="noopener" class="pill">Download</a>
            </div>
            <div class="rating-row">
              <label for="detail-rating"><strong>Rating (0..1):</strong></label>
              <input id="detail-rating" type="number" min="0" max="1" step="0.05" />
              <button id="detail-rate-btn">Speichern</button>
              <span id="detail-rate-status" class="muted"></span>
            </div>
            <div class="rating-row">
              <button id="detail-rehash-btn" class="pill" title="Hash neu berechnen und speichern">Rehash ausf√ºhren</button>
              <span id="detail-rehash-status" class="muted"></span>
            </div>
          </div>
          <hr/>
          <pre id="detail-json" class="json-viewer">{}</pre>
        </div>
      </div>
    </div>
  </main>
<script>
(function(){
  try{
    const u = new URL(window.location.href);
    const embed = (u.searchParams.get('embed') || u.searchParams.get('hideNav') || '').trim();
    if (embed === '1' || embed.toLowerCase() === 'true' || embed.toLowerCase() === 'yes') {
      try{ document.body.classList.add('embed'); }catch{}
      const n0 = document.getElementById('navbar');
      if (n0) n0.innerHTML = '';
      return;
    }

    fetch('/static/nav.html?v=' + Date.now())
      .then(r=>r.text())
      .then(html=>{
        const n=document.getElementById('navbar');
        if(!n) return;
        n.innerHTML=html;
        try{
          n.querySelectorAll('script').forEach(old=>{
            const s=document.createElement('script');
            if(old.src){ s.src = old.src + (old.src.includes('?')?'&':'?') + 'v=' + Date.now(); }
            else { s.textContent = old.textContent || ''; }
            document.body.appendChild(s);
            old.remove();
          });
        }catch{}
      })
      .catch(()=>{});
  }catch{}
})();
</script>
</body>
</html>
