<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>KI_ana – Benutzerverwaltung</title>
  <link href="/static/styles.css" rel="stylesheet">
  <link href="/static/chat.css" rel="stylesheet">
  <style>
    body{background:#f7f9fc;color:#0b1020}
    .container{max-width:1100px;margin:64px auto 24px;padding:0 16px}
    h1{margin:12px 0 8px}
    .card{background:#fff;border-radius:12px;padding:12px;border:1px solid #eef0f5;box-shadow:0 6px 20px rgba(0,0,0,.06);margin:16px 0}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .muted{color:#666}
    .btn{padding:8px 10px;border:1px solid #e5e7eb;border-radius:8px;background:#fff;cursor:pointer}
    .btn:hover{background:#f2f6fb}
    input,select{padding:8px 10px;border:1px solid #e5e7eb;border-radius:8px}
    .pill{display:inline-block;padding:2px 8px;border-radius:999px;background:#eef3fb;color:#23408f;border:1px solid #d7e2f3;font-size:12px}
    .list-row{display:flex;gap:10px;justify-content:space-between;align-items:flex-start;border-top:1px solid #eef0f5;padding:10px 0}
    .toast-wrap{position:fixed;right:16px;top:16px;display:flex;flex-direction:column;gap:8px;z-index:10000}
    .toast{background:#101c3a;color:#e6efff;border:1px solid #2a3d70;border-radius:8px;padding:10px 14px;box-shadow:0 6px 20px rgba(0,0,0,.35);max-width:60vw;opacity:0;transform:translateY(-6px);transition:opacity .2s, transform .2s}
    .toast.ok{background:#0f2a0f;border-color:#2c7a2c}
  </style>
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/static/sw.js').catch(()=>{});
      });
    }
  </script>
</head>
<body>
  <div id="navbar"></div>
  <div class="container">
    <h1>Benutzerverwaltung</h1>

    <div class="card">
      <div class="toolbar">
        <input id="q" placeholder="Suche (Name/Email/ID)" style="flex:1 1 280px">
        <button class="btn" id="reload">↻ Aktualisieren</button>
        <button class="btn" id="csv">⬇ CSV</button>
        <button class="btn" id="runPlan">⚡ Plan Enforcer</button>
      </div>
      <div class="toolbar" style="margin-top:8px">
        <input id="cName" placeholder="Username" style="min-width:140px">
        <input id="cEmail" placeholder="E‑Mail" style="min-width:200px">
        <input id="cPw" placeholder="Passwort" type="password" style="min-width:140px">
        <select id="cRole" aria-label="Rolle">
          <option value="user">user</option>
          <option value="admin">admin</option>
          <option value="creator">creator</option>
        </select>
        <button class="btn" id="create">+ Anlegen</button>
        <span class="muted" id="summary" style="margin-left:auto">—</span>
      </div>
      <div style="overflow:auto;">
        <table style="width:100%; border-collapse:collapse;">
          <thead>
            <tr style="background:#f3f6fb">
              <th style="text-align:left; padding:8px; border-bottom:1px solid #eef0f5; width:60px;">ID</th>
              <th style="text-align:left; padding:8px; border-bottom:1px solid #eef0f5;">Username</th>
              <th style="text-align:left; padding:8px; border-bottom:1px solid #eef0f5;">E‑Mail</th>
              <th style="text-align:left; padding:8px; border-bottom:1px solid #eef0f5; width:140px;">Rolle</th>
              <th style="text-align:left; padding:8px; border-bottom:1px solid #eef0f5; width:180px;">Status</th>
              <th style="text-align:left; padding:8px; border-bottom:1px solid #eef0f5;">Grund</th>
              <th style="text-align:left; padding:8px; border-bottom:1px solid #eef0f5; width:120px;">Aktion</th>
            </tr>
          </thead>
          <tbody id="rows">
            <tr><td colspan="7" class="muted" style="padding:10px;">Lade Nutzer…</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <div class="card">
      <h3 style="margin:0 0 8px">Audit</h3>
      <div class="toolbar">
        <input id="aq" placeholder="Suche (q)" style="min-width:220px">
        <select id="aa">
          <option value="">Alle Aktionen</option>
          <option>user_create</option>
          <option>set_role</option>
          <option>user_set_status</option>
          <option>plan_enforcer_run</option>
        </select>
        <button class="btn" id="aload">↻ Aktualisieren</button>
        <button class="btn" id="acsv">⬇ CSV</button>
      </div>
      <div id="alist" style="margin-top:10px" class="muted">—</div>
    </div>
  </div>
  <div id="toasts" class="toast-wrap"></div>
  <script>
    function toast(msg, ok){
      try{
        const wrap = document.getElementById('toasts');
        const el = document.createElement('div');
        el.className = 'toast' + (ok? ' ok':'');
        el.textContent = msg;
        wrap.appendChild(el);
        requestAnimationFrame(()=>{ el.style.opacity = '1'; el.style.transform = 'translateY(0)'; });
        setTimeout(()=>{ el.style.opacity = '0'; el.style.transform = 'translateY(-6px)'; setTimeout(()=>{ try{ wrap.removeChild(el);}catch{} }, 250); }, 3200);
      }catch{ alert(msg); }
    }
    function rootPrefix(){
      const p = location.pathname||'/'; const i = p.indexOf('/static/'); return (i>=0)? p.slice(0,i): '';
    }
    function escapeHtml(s){ return String(s).replace(/[&<>"']/g,c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c])); }

    // Users
    let cache = [];
    function rowHtml(u){
      const role = String(u.role||'user').toLowerCase();
      const status = String(u.status||'active').toLowerCase();
      const reason = String(u.suspended_reason||'');
      return `<tr data-id="${u.id}" data-role="${role}" data-status="${status}" data-reason="${escapeHtml(reason)}">
        <td style="padding:8px;border-bottom:1px solid #eef0f5;">${u.id}</td>
        <td style="padding:8px;border-bottom:1px solid #eef0f5;">${escapeHtml(u.username||'')}</td>
        <td style="padding:8px;border-bottom:1px solid #eef0f5;">${escapeHtml(u.email||'')}</td>
        <td style="padding:8px;border-bottom:1px solid #eef0f5;">
          <select class="btn role">
            <option value="user" ${role==='user'? 'selected':''}>user</option>
            <option value="admin" ${role==='admin'? 'selected':''}>admin</option>
            <option value="creator" ${role==='creator'? 'selected':''}>creator</option>
          </select>
        </td>
        <td style="padding:8px;border-bottom:1px solid #eef0f5;">
          <select class="btn status">
            <option value="active" ${status==='active'? 'selected':''}>active</option>
            <option value="suspended" ${status==='suspended'? 'selected':''}>suspended</option>
            <option value="banned" ${status==='banned'? 'selected':''}>banned</option>
            <option value="deleted" ${status==='deleted'? 'selected':''}>deleted</option>
          </select>
        </td>
        <td style="padding:8px;border-bottom:1px solid #eef0f5;">
          <input class="btn reason" placeholder="Grund…" value="${escapeHtml(reason)}" ${status==='active'?'disabled':''} style="width:100%" />
        </td>
        <td style="padding:8px;border-bottom:1px solid #eef0f5;">
          <button class="btn save">Speichern</button>
        </td>
      </tr>`;
    }
    function renderTable(items){
      const rows = document.getElementById('rows');
      if (!items.length){ rows.innerHTML = '<tr><td colspan="7" class="muted" style="padding:10px;">Keine Nutzer</td></tr>'; return; }
      rows.innerHTML = items.map(rowHtml).join('');
      rows.querySelectorAll('select.status').forEach(sel=>{
        sel.addEventListener('change', ()=>{
          const tr = sel.closest('tr'); const status = sel.value;
          const reasonEl = tr.querySelector('input.reason');
          reasonEl.disabled = (status==='active');
        });
      });
      rows.querySelectorAll('button.save').forEach(btn=>{
        btn.addEventListener('click', async ()=>{
          const tr = btn.closest('tr'); const id = Number(tr.getAttribute('data-id'))||0; if(!id) return;
          const oldRole = tr.getAttribute('data-role')||'user';
          const oldStatus = tr.getAttribute('data-status')||'active';
          const oldReason = tr.getAttribute('data-reason')||'';
          const role = tr.querySelector('select.role').value;
          const status = tr.querySelector('select.status').value;
          const reason = tr.querySelector('input.reason').value||'';
          try{
            if (role !== oldRole){
              const r1 = await fetch(rootPrefix()+ '/api/admin/users/set-role', { method:'POST', credentials:'include', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ user_id:id, role }) });
              const j1 = await r1.json(); if (!r1.ok || !j1 || j1.ok!==true){ toast('Fehler beim Rollen-Update'); return; }
            }
            if (status !== oldStatus || (status!=='active' && reason !== oldReason)){
              if (status==='deleted' && oldStatus!=='deleted' && !confirm('Benutzer wirklich löschen (Soft-Delete)?')) return;
              if (status==='banned' && oldStatus!=='banned' && !confirm('Benutzer wirklich sperren (banned)?')) return;
              const r2 = await fetch(rootPrefix()+ '/api/admin/users/set-status', { method:'POST', credentials:'include', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ user_id:id, status, reason }) });
              const j2 = await r2.json(); if (!r2.ok || !j2 || j2.ok!==true){ toast('Fehler beim Status-Update'); return; }
            }
            toast('Gespeichert', true); loadUsers();
          }catch{ toast('Fehler beim Speichern'); }
        });
      });
    }
    function filterUsers(items){
      const q = (document.getElementById('q').value||'').toLowerCase().trim();
      if (!q) return items;
      return items.filter(u=>(`${u.id} ${u.username||''} ${u.email||''} ${u.role||''} ${u.status||''}`).toLowerCase().includes(q));
    }
    async function loadUsers(){
      try{
        const r = await fetch(rootPrefix()+ '/api/admin/users', { credentials:'include' });
        const j = await r.json(); if (!r.ok || !j || j.ok===false){ document.getElementById('list').textContent='Fehler beim Laden'; return; }
        cache = Array.isArray(j.items)? j.items: [];
        const f = filterUsers(cache);
        document.getElementById('summary').innerHTML = `Gesamt: <b>${cache.length}</b> · gefiltert: <b>${f.length}</b>`;
        renderTable(f);
      }catch{ document.getElementById('list').textContent='Fehler beim Laden'; }
    }

    // Audit
    async function loadAudit(){
      try{
        const q = (document.getElementById('aq').value||'').trim();
        const a = (document.getElementById('aa').value||'').trim();
        const params = new URLSearchParams(); params.set('limit','50'); if(q) params.set('q', q); if(a) params.set('action', a);
        const r = await fetch(rootPrefix()+ '/api/admin/audit?' + params.toString(), { credentials:'include' });
        const j = await r.json();
        const items = (r.ok && j && Array.isArray(j.items))? j.items: [];
        const html = items.map(it=>{
          const ts = new Date((it.ts||0)*1000).toLocaleString();
          return `<div class="list-row"><div><b>${escapeHtml(it.action||'')}</b> · ${escapeHtml(it.target_type||'')}:${it.target_id} <span class="muted">(${ts})</span><div class="muted">${escapeHtml(JSON.stringify(it.meta||{}))}</div></div></div>`;
        }).join('');
        document.getElementById('alist').innerHTML = html || '<div class="muted">Keine Einträge</div>';
      }catch{ document.getElementById('alist').textContent='Fehler beim Laden'; }
    }

    // CSV helpers
    document.getElementById('csv').addEventListener('click', ()=>{
      try{
        const items = filterUsers(cache);
        const csv = ['id,username,email,role,status,plan,plan_until,daily_quota'];
        items.forEach(u=>csv.push([u.id, `"${(u.username||'').replaceAll('"','""')}"`, `"${(u.email||'').replaceAll('"','""')}"`, u.role||'', u.status||'', u.plan||'', u.plan_until||0, (u.daily_quota!=null?u.daily_quota:'')].join(',')));
        const blob = new Blob([csv.join('\n')], {type:'text/csv'}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href=url; a.download='users.csv'; a.click(); setTimeout(()=>URL.revokeObjectURL(url), 500);
      }catch{}
    });

    // Buttons + inputs
    document.getElementById('reload').addEventListener('click', loadUsers);
    document.getElementById('q').addEventListener('input', ()=>{ const f = filterUsers(cache); document.getElementById('summary').innerHTML = `Gesamt: <b>${cache.length}</b> · gefiltert: <b>${f.length}</b>`; renderTable(f); });
    document.getElementById('create').addEventListener('click', async ()=>{
      try{
        const username = (document.getElementById('cName').value||'').trim();
        const email = (document.getElementById('cEmail').value||'').trim();
        const password = (document.getElementById('cPw').value||'').trim();
        const role = (document.getElementById('cRole').value||'user').trim();
        if (!username || !email || !password){ toast('Bitte Username, E‑Mail und Passwort angeben.'); return; }
        if (password.length < 8){ toast('Passwort muss mindestens 8 Zeichen haben.'); return; }
        if (!email.includes('@') || email.startsWith('@') || email.endsWith('@')){ toast('Bitte gültige E‑Mail angeben.'); return; }
        const r = await fetch(rootPrefix()+ '/api/admin/users/create', { method:'POST', credentials:'include', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ username, email, password, role }) });
        const j = await r.json(); if (r.ok && j && j.ok){ toast('Benutzer angelegt', true); document.getElementById('cName').value=''; document.getElementById('cEmail').value=''; document.getElementById('cPw').value=''; document.getElementById('cRole').value='user'; loadUsers(); } else { toast('Fehler beim Anlegen'); }
      }catch{ toast('Fehler beim Anlegen'); }
    });

    document.getElementById('aload').addEventListener('click', loadAudit);
    document.getElementById('acsv').addEventListener('click', ()=>{
      try{
        const div = document.getElementById('alist');
        const lines = Array.from(div.querySelectorAll('.list-row')).map(x=>x.innerText.replace(/\n/g,' '));
        const blob = new Blob([lines.join('\n')], {type:'text/plain'}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href=url; a.download='audit.txt'; a.click(); setTimeout(()=>URL.revokeObjectURL(url), 500);
      }catch{}
    });

    document.getElementById('runPlan').addEventListener('click', async ()=>{
      try{
        if (!confirm('Plan Enforcer jetzt ausführen?')) return;
        const r = await fetch(rootPrefix()+ '/api/admin/plan-enforcer/run', { method:'POST', credentials:'include' });
        const j = await r.json(); if (r.ok && j && j.ok){ toast('Plan Enforcer: '+(j.suspended||0)+' Nutzer suspendiert', true); loadUsers(); loadAudit(); } else { toast('Plan Enforcer Fehler'); }
      }catch{ toast('Plan Enforcer Fehler'); }
    });

    // Initial
    loadUsers(); loadAudit();
  </script>
  <script>
    // Navbar loader (cache-busting + script execution)
    (function(){
      try{
        fetch('/static/nav.html?v=' + Date.now())
          .then(r=>r.text())
          .then(html=>{
            const n=document.getElementById('navbar');
            if(!n) return;
            n.innerHTML=html;
            try{
              n.querySelectorAll('script').forEach(old=>{
                const s=document.createElement('script');
                if(old.src){ s.src = old.src + (old.src.includes('?')?'&':'?') + 'v=' + Date.now(); }
                else { s.textContent = old.textContent || ''; }
                document.body.appendChild(s);
                old.remove();
              });
            }catch{}
          })
          .catch(()=>{});
      }catch{}
    })();
  </script>
</body>
</html>
