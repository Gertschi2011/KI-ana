<nav class="navbar">
  <div class="nav-left">
    <a href="/static/index.html" class="nav-item" title="Start">ğŸ  Start</a>
    <a href="/static/skills.html" class="nav-item" title="FÃ¤higkeiten">âœ¨ FÃ¤higkeiten</a>
    <a href="/static/chat.html" id="nav-chat" class="nav-item menu-auth" data-role="user" title="Chat" style="display:none">ğŸ’¬ Chat</a>
    <a href="/static/pricing.html#plans" class="nav-item menu-guest" title="Preise" id="nav-pricing">ğŸ’³ Preise</a>
  </div>
  <div class="nav-right">
    <a href="/static/help.html" class="nav-item" title="Hilfe" id="nav-help">â“ Hilfe</a>
    <a href="/static/login.html" class="nav-item menu-guest" title="Login" id="nav-login">ğŸ”‘ Login</a>
    <a href="/static/register.html" class="nav-item menu-guest" title="Registrieren" id="nav-register">ğŸ“ Registrieren</a>
    <div class="dropdown menu-papa" data-role="papa" style="display:none">
      <button class="dropbtn">ğŸ› ï¸ Tools â–¾</button>
      <div class="dropdown-content">
        <a href="/static/dashboard.html">ğŸ“Š Dashboard</a>
        <a href="/ops/grafana/" target="_blank" rel="noreferrer">ğŸ“ˆ Quality (Grafana)</a>
        <a href="/ops/prometheus/" target="_blank" rel="noreferrer">ğŸ§­ Prometheus</a>
        <a href="/static/papa_tools_new.html">âš™ï¸ System Tools</a>
        <a href="/static/timeflow.html">â° TimeFlow</a>
        <a href="/static/addressbook.html">ğŸ—‚ï¸ Adressbuch</a>
        <a href="/static/admin_users.html">ğŸ‘¥ Benutzerverwaltung</a>
        <a href="/static/admin_logs.html">ğŸ“œ Logs</a>
        <a href="/static/block_viewer.html">ğŸ” Block Viewer</a>
      </div>
    </div>
    <div class="dropdown menu-admin" style="display:none">
      <button class="dropbtn" id="user-menu-btn">ğŸ‘¤ <span id="user-name">Admin</span> â–¾</button>
      <div class="dropdown-content">
        <a href="/static/settings.html">âš™ï¸ Einstellungen</a>
        <a href="#" id="nav-change-pw-menu">ğŸ”’ Passwort Ã¤ndern</a>
        <div style="height:1px;background:#e5e7eb;margin:4px 0"></div>
        <a href="/static/dashboard.html" class="show-for-papa" style="display:none">ğŸ“Š Dashboard</a>
        <a href="/ops/grafana/" target="_blank" rel="noreferrer" class="show-for-papa" style="display:none">ğŸ“ˆ Quality (Grafana)</a>
        <a href="/ops/prometheus/" target="_blank" rel="noreferrer" class="show-for-papa" style="display:none">ğŸ§­ Prometheus</a>
        <a href="/static/addressbook.html" class="show-for-all">ğŸ—‚ï¸ Adressbuch</a>
      </div>
    </div>
    <span id="status-dot" title="Serverstatus" style="display:none">ğŸ”´</span>
    <span id="user-badge" style="display:none">ğŸ‘¤ Gast</span>
    <button id="burger-btn" class="nav-item" aria-label="MenÃ¼" title="MenÃ¼" style="display:none">â˜°</button>
    <button id="logout-btn" class="nav-item menu-auth" data-role="user" style="display:none">ğŸšª Logout</button>
  </div>
</nav>

<script>
(async function(){
  try {
    // Status check (fast endpoint)
    try {
      const pong = await fetch('/_/ping');
      document.getElementById('status-dot').textContent = pong && pong.ok ? 'ğŸŸ¢' : 'ğŸ”´';
    } catch { document.getElementById('status-dot').textContent = 'ğŸ”´'; }

    // Auth state via /api/me (cookie session or bearer)
    let me = null;
    try {
      const token = localStorage.getItem('ki_token') || '';
      const r = await fetch('/api/me', token ? { headers: { Authorization: 'Bearer ' + token } } : {});
      if (r.ok) {
        const jd = await r.json();
        me = (jd && jd.auth && jd.user) ? jd.user : null;
      }
    } catch {}

    if (me) {
      // Show auth-only
      document.getElementById('user-badge').textContent = 'ğŸ‘¤ ' + (me.username || 'User');
      document.getElementById('nav-login').style.display = 'none';
      document.getElementById('nav-register').style.display = 'none';
      // Persist username for greeting/fallbacks
      try{
        const uname = me.username || me.email || 'Gast';
        localStorage.setItem('kiana_username', uname);
        if (me.plan) localStorage.setItem('kiana_plan', String(me.plan));
      }catch{}
      // Show Chat on the left when authenticated
      try{ const c = document.getElementById('nav-chat'); if(c) c.style.display='inline'; }catch{}
      // Settings now lives in Admin dropdown; hide any standalone icon if present
      try{ const oldSettings = document.getElementById('nav-settings'); if(oldSettings) oldSettings.style.display='none'; }catch{}
      document.getElementById('logout-btn').style.display = 'inline-block';
      // Hide guest-left items (Start, FÃ¤higkeiten, Preise)
      try{ const aStart = document.querySelector(".nav-left a[href='/static/index.html']"); if(aStart) aStart.style.display='none'; }catch{}
      try{ const aSkills = document.querySelector(".nav-left a[href='/static/skills.html']"); if(aSkills) aSkills.style.display='none'; }catch{}
      try{ const aPrice = document.getElementById('nav-pricing'); if(aPrice) aPrice.style.display='none'; }catch{}
      // Role menus
      const roles = new Set([].concat(me.roles || [], me.role || []).map(x=>String(x).toLowerCase()));
      if (roles.has('papa') || roles.has('creator')) {
        document.querySelectorAll('.menu-papa').forEach(el=>{
          // Ensure internal skills link exists
          try{
            if (!el.querySelector('.link-internal-skills')){
              const dc = el.querySelector('.dropdown-content');
              if (dc){
                const a = document.createElement('a');
                a.href = '/static/papa_skills.html';
                a.textContent = 'ğŸ”§ Skills (intern)';
                a.className = 'link-internal-skills';
                dc.appendChild(a);
              }
            }
          }catch{}
          el.style.display='inline-block';
        });
      }
      // Show username dropdown for all authenticated users
      document.querySelectorAll('.menu-admin').forEach(el=>{
        el.style.display='inline-block';
        try{
          const btn = el.querySelector('.dropbtn');
          if (btn) btn.textContent = 'ğŸ‘¤ ' + (me.username || 'User') + ' â–¾';
        }catch{}
        // Show papa links if user is papa
        if (roles.has('papa') || roles.has('creator') || roles.has('admin')) {
          el.querySelectorAll('.show-for-papa').forEach(a=>{ a.style.display = 'block'; });
        }
        // Admin-only links visibility
        try{
          el.querySelectorAll('.admin-only').forEach(a=>{ a.style.display = roles.has('admin') ? 'block' : 'none'; });
        }catch{}
      });
    } else {
      // Guest view
      document.querySelectorAll('.menu-auth,.menu-papa,.menu-admin').forEach(e=>{ e.style.display='none'; });
      document.getElementById('nav-login').style.display = 'inline';
      document.getElementById('nav-register').style.display = 'inline';
      try{ localStorage.removeItem('kiana_username'); }catch{}
      try{ localStorage.removeItem('kiana_plan'); }catch{}
      // Ensure guest-left items are visible
      try{ const aStart = document.querySelector(".nav-left a[href='/static/index.html']"); if(aStart) aStart.style.display='inline'; }catch{}
      try{ const aSkills = document.querySelector(".nav-left a[href='/static/skills.html']"); if(aSkills) aSkills.style.display='inline'; }catch{}
      try{ const aPrice = document.getElementById('nav-pricing'); if(aPrice) aPrice.style.display='inline'; }catch{}
      // Hide Chat when guest
      try{ const c = document.getElementById('nav-chat'); if(c) c.style.display='none'; }catch{}
    }

    // Logout â€“ simplified and robust
    async function doLogout(){
      try { await fetch('/api/auth/logout', { method:'POST', credentials:'include' }); } catch(e) {}
      try { localStorage.clear(); } catch {}
      try { sessionStorage.clear(); } catch {}
      window.location.replace('/static/index.html?v=' + Date.now());
    }
    const lo = document.getElementById('logout-btn');
    if (lo) { lo.onclick = ()=>{ doLogout(); return false; }; }

    // Change password modal (with validation)
    try{
      // Build modal once and append to body
      if (!document.getElementById('pwModal')){
        const host = document.createElement('div');
        host.id = 'pwModal';
        host.style.cssText = 'position:fixed;inset:0;display:none;place-items:center;z-index:2000';
        host.innerHTML = `
          <div class="modal-backdrop" style="position:absolute;inset:0;background:rgba(0,0,0,.35);"></div>
          <div class="modal" style="position:relative;z-index:1;width:min(520px,92vw);background:#fff;border-radius:16px;padding:18px;box-shadow:0 20px 60px rgba(0,0,0,.25)">
            <h3 style="margin:0 0 12px 0">Passwort Ã¤ndern</h3>
            <form id="pwForm">
              <label style="display:block;margin:8px 0">
                <span style="display:block;font-size:14px;color:#6b7280;margin-bottom:4px">Altes Passwort</span>
                <input id="pwOld" type="password" required minlength="4" style="width:100%;padding:10px 12px;border:1px solid #e5e7eb;border-radius:10px;font-size:15px" />
              </label>
              <label style="display:block;margin:8px 0">
                <span style="display:block;font-size:14px;color:#6b7280;margin-bottom:4px">Neues Passwort</span>
                <input id="pwNew" type="password" required minlength="8" style="width:100%;padding:10px 12px;border:1px solid #e5e7eb;border-radius:10px;font-size:15px" />
              </label>
              <label style="display:block;margin:8px 0">
                <span style="display:block;font-size:14px;color:#6b7280;margin-bottom:4px">Neues Passwort wiederholen</span>
                <input id="pwNew2" type="password" required minlength="8" style="width:100%;padding:10px 12px;border:1px solid #e5e7eb;border-radius:10px;font-size:15px" />
              </label>
              <p id="pwErr" style="color:#b91c1c;min-height:1.2em;margin:6px 0 0 0"></p>
              <div class="actions" style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px">
                <button type="button" id="pwCancel" class="btn ghost" style="background:#f3f4f6;color:#374151;padding:10px 14px;border-radius:12px;border:0">Abbrechen</button>
                <button type="submit" id="pwSave" class="btn primary" style="color:#fff;background:linear-gradient(135deg,#7F5AF0,#00d2ff);box-shadow:0 6px 16px rgba(108,92,231,.35);padding:10px 14px;border-radius:12px;border:0">Speichern</button>
              </div>
            </form>
          </div>`;
        document.body.appendChild(host);
      }
      function openPw(){ try{ const m=document.getElementById('pwModal'); if(m) m.style.display='grid'; }catch{} }
      function closePw(){ try{ const m=document.getElementById('pwModal'); if(m) m.style.display='none'; }catch{} }
      const cp = document.getElementById('nav-change-pw');
      if (cp){ cp.addEventListener('click', (e)=>{ e.preventDefault(); openPw(); }); }
      // Close on backdrop
      try{ document.querySelector('#pwModal .modal-backdrop').addEventListener('click', closePw); }catch{}
      try{ document.getElementById('pwCancel').addEventListener('click', closePw); }catch{}
      // Submit
      try{
        const form = document.getElementById('pwForm');
        form.addEventListener('submit', async (ev)=>{
          ev.preventDefault();
          const oldV = (document.getElementById('pwOld').value||'').trim();
          const n1 = (document.getElementById('pwNew').value||'').trim();
          const n2 = (document.getElementById('pwNew2').value||'').trim();
          const errEl = document.getElementById('pwErr');
          errEl.textContent='';
          if (!oldV || !n1 || !n2){ errEl.textContent='Bitte alle Felder ausfÃ¼llen.'; return; }
          if (n1.length < 8){ errEl.textContent='Neues Passwort: mindestens 8 Zeichen.'; return; }
          if (n1 !== n2){ errEl.textContent='Die neuen PasswÃ¶rter stimmen nicht Ã¼berein.'; return; }
          try{
            const r = await fetch('/api/auth/change-password', { method:'POST', headers:{'Content-Type':'application/json'}, credentials:'include', body: JSON.stringify({ old_password: oldV, new_password: n1 }) });
            const j = await r.json().catch(()=>({}));
            if (!r.ok){ errEl.textContent = (j && (j.detail||j.error)) ? String(j.detail||j.error) : 'Ã„ndern fehlgeschlagen.'; return; }
            errEl.style.color = '#16a34a'; errEl.textContent = 'Passwort geÃ¤ndert.';
            setTimeout(()=>{ closePw(); try{ errEl.style.color = '#b91c1c'; errEl.textContent=''; }catch{} }, 900);
          }catch{ errEl.textContent='Netzwerkfehler.'; }
        });
      }catch{}
    }catch{}

    // --- Mobile burger toggle ---
    function isMobile(){ try{ return window.matchMedia('(max-width: 768px)').matches; }catch{ return false; } }
    function closeMenu(){ try{ document.body.classList.remove('nav-open'); }catch{} }
    const burger = document.getElementById('burger-btn');
    function updateBurgerVisibility(){ try{ burger.style.display = isMobile()? 'inline-block':'none'; if(!isMobile()) closeMenu(); }catch{} }
    try{ updateBurgerVisibility(); window.addEventListener('resize', updateBurgerVisibility); }catch{}
    if (burger){ burger.addEventListener('click', function(){ document.body.classList.toggle('nav-open'); }); }
    // Close on any nav item click
    try{
      document.querySelectorAll('.nav-left a, .dropdown-content a, #nav-settings').forEach(a=>{
        a.addEventListener('click', ()=> closeMenu());
      });
    }catch{}

    // --- Bilingual labels (DE/EN) ---
    function setLabels(lang){
      try{
        const L = (String(lang||'de').toLowerCase() === 'en') ? 'en' : 'de';
        const t = {
          de: {
            start: 'ğŸ  Start', skills: 'âœ¨ FÃ¤higkeiten', pricing: 'ğŸ’³ Preise',
            login: 'ğŸ”‘ Login', register: 'ğŸ“ Registrieren', settings_title: 'Einstellungen'
          },
          en: {
            start: 'ğŸ  Home', skills: 'âœ¨ Skills', pricing: 'ğŸ’³ Pricing',
            login: 'ğŸ”‘ Login', register: 'ğŸ“ Register', settings_title: 'Settings'
          }
        }[L];
        const aStart = document.querySelector(".nav-left a[href='/static/index.html']");
        const aSkills = document.querySelector(".nav-left a[href='/static/skills.html']");
        const aPrice = document.getElementById('nav-pricing');
        const aLogin = document.getElementById('nav-login');
        const aReg = document.getElementById('nav-register');
        const aSett = document.getElementById('nav-settings');
        if (aStart) aStart.textContent = t.start;
        if (aSkills) aSkills.textContent = t.skills;
        if (aPrice) aPrice.textContent = t.pricing;
        if (aLogin) aLogin.textContent = t.login;
        if (aReg) aReg.textContent = t.register;
        if (aSett) aSett.setAttribute('title', t.settings_title);
      }catch{}
    }
    // Initialize labels based on stored language
    try{ setLabels(localStorage.getItem('kiana_lang')||'de'); }catch{}
    // React live to language changes
    try{ window.addEventListener('kiana_lang_change', (e)=> setLabels((e && e.detail && e.detail.lang) || 'de')); }catch{}
  } catch (e) { console.error(e); }
})();
</script>
