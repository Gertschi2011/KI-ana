<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <title>Login ‚Äì KI_ana</title>
  <link rel="stylesheet" href="/static/chat.css?v=20251104-0720"/>
  <script defer src="/static/global_theme.js"></script>
  <style>
    main.auth{max-width:520px;margin:30px auto;padding:20px;background:#fff;border:1px solid #e5e7eb;border-radius:12px}
    body.theme-dark main.auth{background:#0f1622;border-color:#1f2a3a}
    label{display:block;margin:.5rem 0;font-weight:600}
    input{width:100%;padding:.6rem;margin:.2rem 0 .8rem;border:1px solid #d1d5db;border-radius:8px}
    body.theme-dark input{background:#0b1020;color:#dfe6ff;border-color:#1f2a3a}
    button{padding:.6rem 1rem;border-radius:10px;border:1px solid #d1d5db;background:#eef5ff;cursor:pointer}
    body.theme-dark button{background:#1a2230;border-color:#2a3b55;color:#e6efff}
    .alt{background:#fff}
  </style>
</head>
<body>
<div id="navbar"></div>

<main class="auth">
  <h1>üîê Login</h1>
  <form id="f">
    <label>E‚ÄëMail oder Benutzername<input required type="text" name="email" autocomplete="username"/></label>
    <label>Passwort<input required type="password" name="password"/></label>
    <button type="submit">Einloggen</button>
    <a class="btn alt" href="/static/register.html" style="margin-left:.5rem">Registrieren</a>
  </form>
  <p id="msg" style="color:#dc2626"></p>
</main>

<script>
(function(){
  // Load navbar with cache-busting and execute scripts inside fragment
  fetch('/static/nav.html?v=' + Date.now())
    .then(r=>r.text())
    .then(h=>{
      const n = document.getElementById('navbar');
      if (!n) return;
      n.innerHTML = h;
      try{
        n.querySelectorAll('script').forEach(old=>{
          const s=document.createElement('script');
          if(old.src){ s.src = old.src + (old.src.includes('?')?'&':'?') + 'v=' + Date.now(); }
          else { s.textContent = old.textContent || ''; }
          document.body.appendChild(s);
          old.remove();
        });
      }catch{}
    });
  const f=document.getElementById('f');
  f.addEventListener('submit', async (e)=>{
    e.preventDefault();
    const fd=new FormData(f);
    const body={ username:String(fd.get('email')||'').trim(), password:fd.get('password'), remember: false };
    try{
      const r=await fetch('/api/auth/login',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
      const j=await r.json().catch(()=>({}));
      if(!r.ok || !j || !j.token){ document.getElementById('msg').textContent = (j.detail||'Login fehlgeschlagen'); return; }
      // sessionStorage statt localStorage = Auto-Logout beim Tab-Schlie√üen!
      try{ sessionStorage.setItem('ki_token', j.token); }catch{}
      // Redirect ALL users to Dashboard after login
      console.log('üéØ Redirecting to Dashboard...');
      window.location.replace('/static/dashboard.html?t=' + Date.now());
    }catch{ document.getElementById('msg').textContent='Netzwerkfehler'; }
  });
  
  // Show message if logged out due to inactivity
  try {
    const params = new URLSearchParams(window.location.search);
    if (params.get('reason') === 'inactivity') {
      document.getElementById('msg').textContent = 'Du wurdest wegen Inaktivit√§t ausgeloggt.';
      document.getElementById('msg').style.color = '#f59e0b'; // Orange
    }
  } catch {}
})();
</script>
</body>
</html>
