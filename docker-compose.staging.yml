version: "3.9"

services:
  postgres:
    image: postgres:16
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB}
    volumes:
      - pgdata_staging:/var/lib/postgresql/data
    # Optional: expose to host for debugging only
    ports:
      - "25432:5432"
    networks: [kiana_staging]

  redis:
    image: redis:7
    restart: unless-stopped
    volumes:
      - redisdata_staging:/data
    ports:
      - "26379:6379"
    networks: [kiana_staging]

  qdrant:
    image: qdrant/qdrant:latest
    restart: unless-stopped
    volumes:
      - qdrantdata_staging:/qdrant/storage
    ports:
      - "26333:6333"
    networks: [kiana_staging]

  minio:
    image: minio/minio:latest
    command: server /data --console-address ":9001"
    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD}
    volumes:
      - miniodata_staging:/data
    ports:
      - "29000:9000"
      - "29001:9001"
    networks: [kiana_staging]

  backend:
    build:
      context: .
      dockerfile: netapi/Dockerfile
    restart: unless-stopped
    environment:
      ENV: staging
      # Enable deterministic E2E flows on staging (e.g., register returns email_verification_token)
      TEST_MODE: "1"
      DATABASE_URL: postgresql+psycopg2://${POSTGRES_USER}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB}
      BUILD_SHA: ${BUILD_SHA:-}
      KIANA_BUILD_SHA: ${KIANA_BUILD_SHA:-}
      KIANA_VERSION: ${KIANA_VERSION:-}
      REDIS_HOST: redis
      REDIS_PORT: 6379
      QDRANT_HOST: qdrant
      QDRANT_PORT: 6333
      MINIO_ENDPOINT: http://minio:9000
      MINIO_ROOT_USER: ${MINIO_ROOT_USER}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD}
      TZ: Europe/Vienna
      KI_ROOT: /home/kiana/ki_ana
    volumes:
      - /home/kiana/ki_ana/memory:/home/kiana/ki_ana/memory
      - /home/kiana/ki_ana/system:/home/kiana/ki_ana/system:ro
      - /home/kiana/ki_ana/data:/home/kiana/ki_ana/data
    depends_on:
      - postgres
      - redis
      - qdrant
      - minio
    networks: [kiana_staging]
    ports:
      - "28000:8000"

  worker:
    build:
      context: .
      dockerfile: backend/Dockerfile
    command: ["bash","-lc","celery -A backend.workers.celery_app.celery worker -l info"]
    restart: unless-stopped
    environment:
      ENV: staging
      DATABASE_URL: postgresql+psycopg2://${POSTGRES_USER}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB}
      BUILD_SHA: ${BUILD_SHA:-}
      KIANA_BUILD_SHA: ${KIANA_BUILD_SHA:-}
      KIANA_VERSION: ${KIANA_VERSION:-}
      REDIS_HOST: redis
      REDIS_PORT: 6379
    depends_on:
      - backend
      - redis
    networks: [kiana_staging]

  worker_beat:
    build:
      context: .
      dockerfile: backend/Dockerfile
    command: ["bash","-lc","celery -A backend.workers.celery_app.celery beat -l info"]
    restart: unless-stopped
    environment:
      ENV: staging
      DATABASE_URL: postgresql+psycopg2://${POSTGRES_USER}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB}
      BUILD_SHA: ${BUILD_SHA:-}
      KIANA_BUILD_SHA: ${KIANA_BUILD_SHA:-}
      KIANA_VERSION: ${KIANA_VERSION:-}
      REDIS_HOST: redis
      REDIS_PORT: 6379
      TZ: Europe/Vienna
      # Optional safety rollout (set to "1" to only report counts, no deletes)
      # RETENTION_DRY_RUN: "1"
      # RETENTION_CHAT_DAYS: "30"
      # RETENTION_PURGE_HOUR: "3"
      # RETENTION_PURGE_MINUTE: "25"
    depends_on:
      - redis
    networks: [kiana_staging]

  frontend:
    build: ./frontend
    restart: unless-stopped
    environment:
      NEXT_PUBLIC_API_BASE: ${NEXT_PUBLIC_API_BASE}
      NEXT_PUBLIC_ENV: staging
    depends_on:
      - backend
    ports:
      - "23000:3000"
    networks: [kiana_staging]

volumes:
  pgdata_staging: {}
  redisdata_staging: {}
  qdrantdata_staging: {}
  miniodata_staging: {}

networks:
  kiana_staging: {}
