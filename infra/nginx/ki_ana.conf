server {
  listen 80;
  listen [::]:80;
  server_name ki-ana.at www.ki-ana.at;

  # ACME HTTP-01 challenge endpoint
  location /.well-known/acme-challenge/ {
    root /var/www/certbot;
  }

  # Redirect everything else to HTTPS
  location / {
    return 301 https://$host$request_uri;
  }
}

server {
  listen 443 ssl;
  listen [::]:443 ssl;
  server_name ki-ana.at www.ki-ana.at;

  ssl_certificate /etc/letsencrypt/live/ki-ana.at/fullchain.pem;
  ssl_certificate_key /etc/letsencrypt/live/ki-ana.at/privkey.pem;
  ssl_protocols TLSv1.2 TLSv1.3;
  ssl_prefer_server_ciphers on;

  # Security headers
  add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;
  add_header X-Content-Type-Options nosniff;
  add_header X-Frame-Options SAMEORIGIN;
  add_header Referrer-Policy strict-origin-when-cross-origin;
  add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' blob:; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; img-src 'self' data:; font-src 'self' data: https://fonts.gstatic.com; connect-src 'self' https://api.$host https://app.$host blob:; frame-ancestors 'self';" always;

  # Health passt durch (Backend-Liveness)
  location = /health {
    proxy_pass http://backend:8000/health;
    proxy_set_header Host $host;
  }

  # Favicon aus bestehendem Static-Verzeichnis ausliefern
  location = /favicon.ico {
    alias /home/kiana/ki_ana/netapi/static/favicon.ico;
  }

  # API (Backend, ohne abschließenden Slash beim proxy_pass)
  location /api/ {
    proxy_pass http://backend:8000;
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
  }

  # SSE Events → Backend (kein Buffering, lange Timeouts)
  location /events {
    proxy_pass http://backend:8000;
    proxy_http_version 1.1;
    proxy_set_header Connection "";
    proxy_buffering off;
    proxy_read_timeout 3600s;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
  }

  # LiveLog SSE → Backend (no buffering)
  location = /api/livelog/stream {
    proxy_pass http://backend:8000;
    proxy_http_version 1.1;
    proxy_set_header Connection "";
    proxy_buffering off;
    proxy_read_timeout 3600s;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
  }

  # Block Viewer API → Backend
  location /viewer/ {
    proxy_pass http://backend:8000;
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
  }

  # Static Files (netapi/static)
  location /static/ {
    alias /home/kiana/ki_ana/netapi/static/;
    expires 1h;
    add_header Cache-Control "public, immutable";
    autoindex off;
  }

  # Root → index.html aus static
  location = / {
    rewrite ^ /static/index.html permanent;
  }

  # Next.js Frontend unter /app/
  location /app/ {
    proxy_pass http://frontend:3000/;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
  }

  # Ops UIs (Grafana/Prometheus) – behind Basic Auth
  # Requires an htpasswd file mounted at /etc/nginx/conf.d/.htpasswd-ops
  location /ops/grafana/ {
    auth_basic "KI_ana Ops";
    auth_basic_user_file /etc/nginx/conf.d/.htpasswd-ops;
    add_header Content-Security-Policy "default-src * data: blob: 'unsafe-inline' 'unsafe-eval'; img-src * data: blob:; style-src * 'unsafe-inline'; font-src * data:; connect-src * data: blob:; frame-ancestors 'self';" always;
    proxy_pass http://grafana:3000/;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
  }

  location /ops/prometheus/ {
    auth_basic "KI_ana Ops";
    auth_basic_user_file /etc/nginx/conf.d/.htpasswd-ops;
    add_header Content-Security-Policy "default-src * data: blob: 'unsafe-inline' 'unsafe-eval'; img-src * data: blob:; style-src * 'unsafe-inline'; font-src * data:; connect-src * data: blob:; frame-ancestors 'self';" always;
    proxy_pass http://prometheus:9090/;
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
  }

  # Back-compat: old paths
  location /grafana/ { return 302 /ops/grafana/; }
  location /prometheus/ { return 302 /ops/prometheus/; }

  # Pretty URLs
  # Primary chat UI is the Next.js app
  location = /chat { return 302 /app/chat; }
  # LiveLog entrypoint (legacy viewer; links to /app/livelog)
  location = /livelog { return 302 /static/livelog.html; }
  # Legacy static chat page redirects to /chat
  location = /static/chat.html { return 302 /chat; }
  location = /papa { return 302 /static/papa.html; }
  location = /skills { return 302 /static/skills.html; }
  location = /faehigkeiten { return 302 /static/skills.html; }
  location = /pricing { return 302 /static/pricing.html; }
  location = /capabilities { return 302 /static/capabilities.html; }
  location = /start { return 302 /static/index.html; }

  # User uploads (if present)
  location /uploads/ {
    alias /home/kiana/ki_ana/netapi/uploads/;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_read_timeout 600s;
  }

  # (API handled above)

  # MinIO Console (optional)
  location /minio/ {
    proxy_pass http://minio:9001/;
  }
}
