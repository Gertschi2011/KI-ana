================================================================
>> FILE: /home/kiana/ki_ana/deploy/.env.example
================================================================
# KI_ana deployment example environment
# Copy to .env and adjust values for your environment

# Secret for signing cookies/JWT fallbacks (keep private)
KI_SECRET=•••

# Frontend: Upgrade target URL for Papa subscription (optional)
# If unset, frontend falls back to /static/upgrade.html
KI_UPGRADE_URL=https://ki-ana.at/abo

# Quota defaults for free tier users (applied when user.daily_quota is not set)
# Used by deps.DEFAULT_FREE_DAILY_QUOTA and surfaced via /api/system/config
FREE_DAILY_QUOTA=20

# Ollama local LLM settings
OLLAMA_HOST=http://127.0.0.1:11434

# Preferred model selection (DEFAULT/ALT) controlled by KIANA_MODEL_ID.
# Set KIANA_MODEL_ID to either OLLAMA_MODEL_DEFAULT or OLLAMA_MODEL_ALT to switch.
# Example: small default (3b), stronger alt (8b)
OLLAMA_MODEL_DEFAULT=llama3.2:3b
OLLAMA_MODEL_ALT=llama3.1:8b

# Active model selection (must match one of the above)
KIANA_MODEL_ID=llama3.2:3b

# Lock UI so users cannot change the model client-side
KIANA_MODEL_LOCK=1
KIANA_UI_DISABLE_MODEL_SELECTOR=1

# Optional: Legacy override (if set, takes precedence over DEFAULT/ALT)
# OLLAMA_MODEL=llama3.1:8b

# Planner (deliberation) toggle – requires a stronger local model
# 1 = enabled (default), 0 = disabled (fallback to legacy streaming)
KI_PLANNER_ENABLED=1

# Optional: Root path behind reverse proxy (leave empty for none)
ROOT_PATH=

# Device Events pruning (defaults)
# Keep only recent events; see system/device_events_prune.py and deploy/README.md
KI_DEVICE_EVENTS_TTL_DAYS=7
KI_DEVICE_EVENTS_MAX_DEPTH=100

# Enforce tokens even for localhost heartbeats/events (production recommended)
# 0 = allow localhost without token (dev default)
# 1 = require Bearer ••• also on localhost
OS_DEVICES_LOCALHOST_REQUIRES_TOKEN=•••


================================================================
>> FILE: /home/kiana/ki_ana/deploy/systemd/kiana-crawler-worker.service
================================================================
[Unit]
Description=KI_ana Crawler Worker
After=network.target

[Service]
Type=simple
User=kiana
WorkingDirectory=/home/kiana/ki_ana
Environment=PYTHONUNBUFFERED=1
ExecStart=/usr/bin/python3 /home/kiana/ki_ana/system/crawler_worker.py
Restart=always
RestartSec=3
StandardOutput=journal
StandardError=journal

[Install]
WantedBy=multi-user.target


================================================================
>> FILE: /home/kiana/ki_ana/deploy/systemd/kiana-device-events-prune.service
================================================================
[Unit]
Description=KI_ana Device Events Prune
After=network.target

[Service]
User=kiana
WorkingDirectory=/home/kiana/ki_ana
EnvironmentFile=/home/kiana/ki_ana/.env
ExecStart=/bin/bash -lc 'source /home/kiana/ki_ana/.venv/bin/activate 2>/dev/null || true; python3 system/device_events_prune.py --days ${KI_DEVICE_EVENTS_TTL_DAYS:-7} --max ${KI_DEVICE_EVENTS_MAX_DEPTH:-100}'
Restart=no

[Install]
WantedBy=multi-user.target


================================================================
>> FILE: /home/kiana/ki_ana/deploy/systemd/kiana-device-events-prune.timer
================================================================
[Unit]
Description=Run KI_ana Device Events Prune daily at 04:00

[Timer]
OnCalendar=*-*-* 04:00:00
Persistent=true
Unit=kiana-device-events-prune.service

[Install]
WantedBy=timers.target


================================================================
>> FILE: /home/kiana/ki_ana/deploy/systemd/kiana-device-events-stats.service
================================================================
[Unit]
Description=KI_ana Device Events Stats Rollup (hourly)
After=network.target

[Service]
User=kiana
WorkingDirectory=/home/kiana/ki_ana
EnvironmentFile=/home/kiana/ki_ana/.env
ExecStart=/bin/bash -lc 'source /home/kiana/ki_ana/.venv/bin/activate 2>/dev/null || true; python3 system/device_events_stats_rollup.py'
Restart=no

[Install]
WantedBy=multi-user.target


================================================================
>> FILE: /home/kiana/ki_ana/deploy/systemd/kiana-device-events-stats.timer
================================================================
[Unit]
Description=Run KI_ana Device Events Stats Rollup hourly at minute 05

[Timer]
OnCalendar=*-*-* *:05:00
Persistent=true
Unit=kiana-device-events-stats.service

[Install]
WantedBy=timers.target


================================================================
>> FILE: /home/kiana/ki_ana/deploy/systemd/kiana-knowledge-prune.service
================================================================
[Unit]
Description=KI_ana Knowledge Prune (knowledge_blocks TTL)
After=network.target

[Service]
Type=oneshot
User=kiana
WorkingDirectory=/home/kiana/ki_ana
Environment=PYTHONUNBUFFERED=1
# Uses env KI_KNOWLEDGE_TTL_DAYS unless overridden by --days
ExecStart=/usr/bin/python3 /home/kiana/ki_ana/system/knowledge_prune.py

[Install]
WantedBy=multi-user.target


================================================================
>> FILE: /home/kiana/ki_ana/deploy/systemd/kiana-knowledge-prune.timer
================================================================
[Unit]
Description=Run Knowledge Prune daily

[Timer]
OnCalendar=daily
Persistent=true
Unit=kiana-knowledge-prune.service

[Install]
WantedBy=timers.target


================================================================
>> FILE: /home/kiana/ki_ana/deploy/systemd/kiana-media-worker.service
================================================================
[Unit]
Description=KI_ana Media Worker
After=network.target

[Service]
Type=simple
User=kiana
WorkingDirectory=/home/kiana/ki_ana
Environment=PYTHONUNBUFFERED=1
ExecStart=/usr/bin/python3 /home/kiana/ki_ana/system/media_worker.py
Restart=always
RestartSec=3
StandardOutput=journal
StandardError=journal

[Install]
WantedBy=multi-user.target


================================================================
>> FILE: /home/kiana/ki_ana/deploy/systemd/kiana-plan-enforcer.service
================================================================
[Unit]
Description=KI_ana Plan Enforcer (auto-suspend expired plans)
After=network.target

[Service]
Type=oneshot
User=kiana
WorkingDirectory=/home/kiana/ki_ana
Environment=PYTHONUNBUFFERED=1
Environment=KI_ROOT=/home/kiana/ki_ana
Environment=DATABASE_URL=sqlite:////home/kiana/ki_ana/db.sqlite3
ExecStart=/usr/bin/python3 /home/kiana/ki_ana/system/plan_enforcer.py

[Install]
WantedBy=multi-user.target


================================================================
>> FILE: /home/kiana/ki_ana/deploy/systemd/kiana-plan-enforcer.timer
================================================================
[Unit]
Description=Daily KI_ana Plan Enforcer Timer

[Timer]
OnCalendar=daily
Persistent=true
Unit=kiana-plan-enforcer.service

[Install]
WantedBy=timers.target


================================================================
>> FILE: /home/kiana/ki_ana/deploy/systemd/kiana-plan-worker.service
================================================================
[Unit]
Description=KI_ana Planner Worker
After=network.target

[Service]
Type=simple
User=kiana
WorkingDirectory=/home/kiana/ki_ana
Environment=PYTHONUNBUFFERED=1
# Uses ADMIN_API_TOKEN if present for auth
ExecStart=/usr/bin/python3 /home/kiana/ki_ana/system/plan_worker.py
Restart=on-failure
RestartSec=3

[Install]
WantedBy=multi-user.target


================================================================
>> FILE: /home/kiana/ki_ana/deploy/systemd/kiana.service
================================================================
[#] /etc/systemd/system/kiana.service
[Unit]
Description=KI_ana FastAPI service
After=network.target

[Service]
Type=simple
User=%i
WorkingDirectory=/home/%i/ki_ana
Environment=PORT=8000
Environment=HOST=127.0.0.1
Environment=RELOAD=0
ExecStart=/bin/bash -lc '/home/%i/start-kiana.sh'
Restart=always
RestartSec=3

[Install]
WantedBy=multi-user.target



================================================================
>> FILE: /home/kiana/ki_ana/deploy/systemd/kiana-skill-runner.service
================================================================
[Unit]
Description=KI_ana Skill Runner
After=network.target

[Service]
Type=simple
User=%i
WorkingDirectory=/home/%i/ki_ana
Environment=PYTHONUNBUFFERED=1
ExecStart=/usr/bin/python3 /home/%i/ki_ana/system/skill_runner.py
Restart=always
RestartSec=5

[Install]
WantedBy=multi-user.target



================================================================
>> FILE: /home/kiana/ki_ana/deploy/systemd/kiana-telemetry-prune.service
================================================================
[Unit]
Description=KI_ana Telemetry Prune (browser_errors TTL)
After=network.target

[Service]
Type=oneshot
User=kiana
WorkingDirectory=/home/kiana/ki_ana
Environment=PYTHONUNBUFFERED=1
ExecStart=/usr/bin/python3 /home/kiana/ki_ana/system/telemetry_prune.py --days 30

[Install]
WantedBy=multi-user.target


================================================================
>> FILE: /home/kiana/ki_ana/deploy/systemd/kiana-telemetry-prune.timer
================================================================
[Unit]
Description=Daily KI_ana Telemetry Prune Timer

[Timer]
OnCalendar=daily
Persistent=true
Unit=kiana-telemetry-prune.service

[Install]
WantedBy=timers.target


================================================================
>> FILE: /home/kiana/ki_ana/deploy/systemd/kiana-verify-chain.service
================================================================
[Unit]
Description=KI_ana Verify Chain
After=network.target

[Service]
Type=oneshot
User=%i
WorkingDirectory=/home/%i/ki_ana
ExecStart=/bin/bash -lc '/home/%i/ki_ana/system/bin/run_verify_chain.sh'

[Install]
WantedBy=multi-user.target



================================================================
>> FILE: /home/kiana/ki_ana/deploy/systemd/kiana-verify-chain.timer
================================================================
[Unit]
Description=Run KI_ana verify_chain periodically

[Timer]
OnCalendar=hourly
Persistent=true

[Install]
WantedBy=timers.target



================================================================
>> FILE: /home/kiana/ki_ana/docker/subki/docker-compose.yml
================================================================
version: '3.8'

services:
  subki:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: subki_ana
    ports:
      - "5055:5055"
    volumes:
      - ../../:/root/ki_ana
    working_dir: /root/ki_ana
    environment:
      - ENABLE_CRON=true
      - CRON_INTERVAL_SECONDS=86400
      - MOTHER_KI_URL=http://host.docker.internal:8000/api/subki/sync
    restart: unless-stopped


================================================================
>> FILE: /home/kiana/ki_ana/docker/subki/Dockerfile
================================================================
# Multi-arch friendly base; use buildx to target linux/arm64 or linux/arm/v7 for Raspberry Pi
FROM python:3.10-slim

ENV PYTHONDONTWRITEBYTECODE=1 \
    PYTHONUNBUFFERED=1 \
    PIP_NO_CACHE_DIR=1 \
    KI_ROOT=/root/ki_ana

# System deps
RUN apt-get update && apt-get install -y --no-install-recommends \
    ca-certificates curl tzdata \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /app

# Copy minimal KI_ana subset needed for Sub-KI server
# Assuming we mount the full repo at runtime; keep image small by copying only required modules
COPY requirements.txt /app/requirements.txt
RUN pip install --no-cache-dir -r /app/requirements.txt

# Copy runtime files
COPY entrypoint.sh /app/entrypoint.sh
RUN chmod +x /app/entrypoint.sh

# The Sub-KI server code path inside KI_ana project
# Expect the project to be mounted at /root/ki_ana
VOLUME ["/root/ki_ana"]
EXPOSE 5055

# Optional cron-like loop can be enabled via ENABLE_CRON=true
ENV ENABLE_CRON=false \
    CRON_INTERVAL_SECONDS=86400 \
    MOTHER_KI_URL=http://host.docker.internal:8000

ENTRYPOINT ["/app/entrypoint.sh"]


================================================================
>> FILE: /home/kiana/ki_ana/docker/subki/requirements.txt
================================================================
Flask==2.3.3
requests==2.32.3
PyNaCl==1.5.0
# Optional: for signing if needed by local agent
cryptography==42.0.5


================================================================
>> FILE: /home/kiana/ki_ana/.env
================================================================
DATABASE_URL=sqlite:////home/kiana/ki_ana/db.sqlite3
KI_ROOT=/home/kiana/ki_ana
KI_SECRET=•••
OLLAMA_HOST=http://127.0.0.1:11434
OLLAMA_MODEL_DEFAULT=llama3.2:3b
OLLAMA_MODEL_ALT=llama3.1:8b
KIANA_MODEL_LOCK=1
KIANA_MODEL_ID=llama3.2:3b
KIANA_UI_DISABLE_MODEL_SELECTOR=1
KIANA_STATUS_FILE=./runtime/llm_status.json
KI_PLANNER_ENABLED=1
KI_PLANNER_TIMEOUT=3        # Sekunden Timeout bevor Safety-Valve greift
AUTONOMY_WEB_OK_DEFAULT=1   # Web-Suche standardmäßig aktiv
GUARDIAN_AUTO_SUGGEST=1     # Guardian schlägt automatisch Regeln vor
VISION_FILE=netapi/config/vision.json
VISION_ENFORCE=1            # Vision-Tags automatisch an jeden Block anhängen
DEBUG_UI=1                  # Admin/Creator sieht Transparenz-Hinweise inline
KI_CREATOR_FULL_ACCESS=1    # Erlaubt volles Editing im Shell-UI
KI_DEBUG_SAVE=0
ELEVEN_API_KEY=•••
ELEVEN_VOICE_ID=21m00Tcm4TlvDq8ikWAM
MINIO_ENDPOINT=localhost:9000
MINIO_ACCESS_KEY=•••
MINIO_SECRET_KEY=•••
MINIO_BUCKET=artifacts
MINIO_SECURE=false
DEBUG=true
ROOT_PATH=/
ALLOW_NET=1
CHAIN_APPEND=1
IDLE_MINUTES=15
AUTOPILOT_INTERVAL_MIN=30
AUTOPILOT_INTERVAL_MAX=90
FREE_DAILY_QUOTA=20
KI_UPGRADE_URL=https://ki-ana.at/abo
KI_THEME_DEFAULT=light
KI_LANG_DEFAULT=de
KI_ETHICS_FILTER=default


================================================================
>> FILE: /home/kiana/ki_ana/.env.from_KI_ana2.20250928_200355.new
================================================================
# Global
ORG_NAME="Elektro Smart Energy Gerald Stiefsohn e.U."
PROJECT="KI_ana"
DOMAIN_BASE="ki-ana.at"

# Postgres
POSTGRES_USER=ki
POSTGRES_PASSWORD=•••
POSTGRES_DB=kiana
POSTGRES_HOST=postgres
POSTGRES_PORT=5432
DATABASE_URL=postgresql+psycopg2://${POSTGRES_USER}:${POSTGRES_PASSWORD}@${POSTGRES_HOST}:${POSTGRES_PORT}/${POSTGRES_DB}

# Redis
REDIS_HOST=redis
REDIS_PORT=6379

# Qdrant
QDRANT_HOST=qdrant
QDRANT_PORT=6333

# MinIO
MINIO_ROOT_USER=minioadmin
MINIO_ROOT_PASSWORD=•••
MINIO_ENDPOINT=http://minio:9000
MINIO_BUCKET=ki-ana
MINIO_REGION=eu

# JWT / Security
JWT_SECRET=•••
ACCESS_TOKEN_EXPIRE_MINUTES=•••
REFRESH_TOKEN_EXPIRE_DAYS=•••

# Ollama
OLLAMA_MODEL_DEFAULT="llama3.2:3b"
OLLAMA_MODEL_ALT="llama3.1:8b"

# Features
FEATURE_VOICE=0
FEATURE_P2P=0

# Emergency Override
EMERGENCY_OVERRIDE_SHA256="2e193b8e34dc119f0031dda0e380ef68033845f17e11894b89fe93f98e7185c0"

# CORS
CORS_ORIGINS="https://app.${DOMAIN_BASE}"

# Frontend
NEXT_PUBLIC_API_BASE="https://api.${DOMAIN_BASE}"

# CI / Registry (placeholders)
GHCR_IMAGE_API="ghcr.io/gertschi/ki_ana-api:latest"
GHCR_IMAGE_WEB="ghcr.io/gertschi/ki_ana-web:latest"


================================================================
>> FILE: /home/kiana/ki_ana/.env.from_KI_ana2.20250928_200403.new
================================================================
# Global
ORG_NAME="Elektro Smart Energy Gerald Stiefsohn e.U."
PROJECT="KI_ana"
DOMAIN_BASE="ki-ana.at"

# Postgres
POSTGRES_USER=ki
POSTGRES_PASSWORD=•••
POSTGRES_DB=kiana
POSTGRES_HOST=postgres
POSTGRES_PORT=5432
DATABASE_URL=postgresql+psycopg2://${POSTGRES_USER}:${POSTGRES_PASSWORD}@${POSTGRES_HOST}:${POSTGRES_PORT}/${POSTGRES_DB}

# Redis
REDIS_HOST=redis
REDIS_PORT=6379

# Qdrant
QDRANT_HOST=qdrant
QDRANT_PORT=6333

# MinIO
MINIO_ROOT_USER=minioadmin
MINIO_ROOT_PASSWORD=•••
MINIO_ENDPOINT=http://minio:9000
MINIO_BUCKET=ki-ana
MINIO_REGION=eu

# JWT / Security
JWT_SECRET=•••
ACCESS_TOKEN_EXPIRE_MINUTES=•••
REFRESH_TOKEN_EXPIRE_DAYS=•••

# Ollama
OLLAMA_MODEL_DEFAULT="llama3.2:3b"
OLLAMA_MODEL_ALT="llama3.1:8b"

# Features
FEATURE_VOICE=0
FEATURE_P2P=0

# Emergency Override
EMERGENCY_OVERRIDE_SHA256="2e193b8e34dc119f0031dda0e380ef68033845f17e11894b89fe93f98e7185c0"

# CORS
CORS_ORIGINS="https://app.${DOMAIN_BASE}"

# Frontend
NEXT_PUBLIC_API_BASE="https://api.${DOMAIN_BASE}"

# CI / Registry (placeholders)
GHCR_IMAGE_API="ghcr.io/gertschi/ki_ana-api:latest"
GHCR_IMAGE_WEB="ghcr.io/gertschi/ki_ana-web:latest"


================================================================
>> FILE: /home/kiana/ki_ana/.env.merged.20250928_200421
================================================================
DATABASE_URL=sqlite:////home/kiana/ki_ana/db.sqlite3
KI_ROOT=/home/kiana/ki_ana
KI_SECRET=•••
OLLAMA_HOST=http://127.0.0.1:11434
OLLAMA_MODEL_DEFAULT=llama3.2:3b
OLLAMA_MODEL_ALT=llama3.1:8b
KIANA_MODEL_LOCK=1
KIANA_MODEL_ID=llama3.2:3b
KIANA_UI_DISABLE_MODEL_SELECTOR=1
KIANA_STATUS_FILE=./runtime/llm_status.json
KI_PLANNER_ENABLED=1
KI_PLANNER_TIMEOUT=3        # Sekunden Timeout bevor Safety-Valve greift
AUTONOMY_WEB_OK_DEFAULT=1   # Web-Suche standardmäßig aktiv
GUARDIAN_AUTO_SUGGEST=1     # Guardian schlägt automatisch Regeln vor
VISION_FILE=netapi/config/vision.json
VISION_ENFORCE=1            # Vision-Tags automatisch an jeden Block anhängen
DEBUG_UI=1                  # Admin/Creator sieht Transparenz-Hinweise inline
KI_CREATOR_FULL_ACCESS=1    # Erlaubt volles Editing im Shell-UI
KI_DEBUG_SAVE=0
ELEVEN_API_KEY=•••
ELEVEN_VOICE_ID=21m00Tcm4TlvDq8ikWAM
MINIO_ENDPOINT=localhost:9000
MINIO_ACCESS_KEY=•••
MINIO_SECRET_KEY=•••
MINIO_BUCKET=artifacts
MINIO_SECURE=false
DEBUG=true
ROOT_PATH=/
ALLOW_NET=1
CHAIN_APPEND=1
IDLE_MINUTES=15
AUTOPILOT_INTERVAL_MIN=30
AUTOPILOT_INTERVAL_MAX=90
FREE_DAILY_QUOTA=20
KI_UPGRADE_URL=https://ki-ana.at/abo
KI_THEME_DEFAULT=light
KI_LANG_DEFAULT=de
KI_ETHICS_FILTER=default
DOMAIN_BASE=ki-ana.at
EMERGENCY_OVERRIDE_SHA256=2e193b8e34dc119f0031dda0e380ef68033845f17e11894b89fe93f98e7185c0
CORS_ORIGINS=https://app.ki-ana.at
NEXT_PUBLIC_API_BASE=https://api.ki-ana.at
GHCR_IMAGE_API=ghcr.io/gertschi/ki_ana-api:latest
GHCR_IMAGE_WEB=ghcr.io/gertschi/ki_ana-web:latest
COMPOSE_PROJECT_NAME=ki_ana


================================================================
>> FILE: /home/kiana/ki_ana/netapi/.gitignore
================================================================
__pycache__/
.cache/
.dotnet/
*.body
*.log
*.db
*.tar.gz
.venv/
.bak/
sessions.json
.env


================================================================
>> FILE: /home/kiana/ki_ana/.pytest_cache/.gitignore
================================================================
# Created by pytest automatically.
*


================================================================
>> FILE: /home/kiana/ki_ana/requirements.txt
================================================================
# --- Web-Framework & Server ---
fastapi>=0.110,<1.0
uvicorn[standard]>=0.30,<1.0      # bringt uvloop, httptools, watchfiles, websockets mit
aiofiles>=23.2,<24.0
Jinja2>=3.1,<4.0
orjson>=3.9                       # schneller JSON-Serializer (optional, aber nice)

# --- Config & Settings ---
python-dotenv>=1.0,<2.0
pydantic>=2.6,<3.0
pydantic-settings>=2.2,<3.0

# --- Auth & Security ---
passlib[bcrypt]>=1.7,<2.0
itsdangerous>=2.2,<3.0
python-multipart>=0.0.9           # Form/File-Uploads
email-validator>=2.1,<3.0         # falls du E-Mail-Felder validierst

# --- Datenbank ---
SQLAlchemy>=2.0,<2.1
# psycopg2-binary>=2.9,<3.0       # nur falls du später PostgreSQL nutzt (aktuell SQLite)

# --- HTTP & Parsing ---
requests>=2.31
httpx>=0.27,<0.28
beautifulsoup4>=4.12
lxml>=4.9
python-dateutil>=2.8
json5>=0.9
colorama>=0.4

# --- Speech/Audio ---
SpeechRecognition>=3.8
pyaudio>=0.2.14
pyttsx3>=2.90

# --- NLP & AI ---
nltk>=3.8
transformers>=4.40
torch>=2.1                         # Hinweis: auf ARM/aarch64 kann die Installation länger dauern;
                                   # falls Probleme auftreten, melden – dann nehmen wir eine passende Wheel-Quelle.

sse-starlette>=1.6,<2.0


